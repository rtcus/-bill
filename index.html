<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¦å•ç®¡ç†ç³»ç»Ÿ</title>
    
    <!-- å¼•å…¥å¿…è¦çš„CSSåº“ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- è´¦å•ç®¡ç†ä¸“ç”¨CSS -->
    <style>
        :root {
            --primary-color: #1a3c8b;
            --secondary-color: #2d5aa0;
            --accent-color: #4a90e2;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --border-radius: 6px;
        }

        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h3 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 0.9rem;
        }

        /* ç”¨æˆ·ä¿¡æ¯æ  */
        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }

        .user-info .username {
            font-weight: 600;
            color: var(--primary-color);
        }

        .logout-btn {
            padding: 5px 10px;
            font-size: 0.85rem;
        }

        /* ä¸»é¡µé¢æ ·å¼ - ä¿®å¤ï¼šç§»é™¤display:none */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            margin: 0;
            padding: 20px;
            /* display: none; ç§»é™¤è¿™è¡Œ */
        }

        /* ä¿®å¤ï¼šä¸»é¡µé¢åˆå§‹éšè— */
        #mainContent {
            display: none;
        }

        .page-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eaeaea;
        }

        .page-header h2 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.8rem;
        }

        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .card-header {
            background-color: white;
            border-bottom: 1px solid #eaeaea;
            padding: 15px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1rem;
        }

        .form-control, .form-select {
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            padding: 8px 12px;
            font-size: 0.95rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: var(--border-radius);
            padding: 8px 16px;
            font-size: 0.95rem;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: var(--border-radius);
            font-size: 0.95rem;
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
        .status-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
        }

        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .status-card h5 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .status-card .count {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .text-primary { color: var(--primary-color) !important; }
        .text-warning { color: var(--warning-color) !important; }
        .text-info { color: var(--accent-color) !important; }
        .text-success { color: var(--success-color) !important; }

        /* è¡¨æ ¼å®¹å™¨è®¾ç½® */
        .table-card-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .table-card-header {
            background-color: white;
            border-bottom: 1px solid #eaeaea;
            padding: 15px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1rem;
            flex-shrink: 0;
        }

        .table-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .table-container {
            border-radius: 0;
            overflow-x: auto;
            overflow-y: auto;
            width: 100%;
            flex: 1;
            border-bottom: 1px solid #eaeaea;
        }

        .table {
            width: 100%;
            margin-bottom: 0;
            table-layout: auto;
        }

        .table th {
            background-color: #f8f9fa;
            color: var(--primary-color);
            font-weight: 600;
            border-top: none;
            font-size: 0.9rem;
            padding: 10px 12px;
            position: sticky;
            top: 0;
            z-index: 10;
            user-select: none;
            white-space: nowrap;
        }

        .table td {
            font-size: 0.9rem;
            padding: 10px 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .table-warning {
            background-color: #fff3cd !important;
        }

        .table-info {
            background-color: #e3f2fd !important;
        }

        .table-success {
            background-color: #e8f5e9 !important;
        }

        .fee-edit-input {
            min-width: 80px;
            text-align: center;
        }

        .preview-table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
        }

        /* åˆ†é¡µæ§ä»¶ */
        .pagination-container {
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 1px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .pagination {
            margin: 0;
            justify-content: center;
            flex: 1;
        }

        .pagination-info {
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
            white-space: nowrap;
            margin-right: 20px;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .page-size-selector select {
            width: auto;
            padding: 5px 10px;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-content {
            border-radius: var(--border-radius);
            border: none;
        }

        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-bottom: none;
        }

        .modal-footer {
            border-top: 1px solid #eaeaea;
        }

        /* å¾½ç« æ ·å¼ */
        .badge {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .bg-warning {
            background-color: var(--warning-color) !important;
        }

        .bg-info {
            background-color: var(--accent-color) !important;
        }

        .bg-success {
            background-color: var(--success-color) !important;
        }

        .bg-secondary {
            background-color: #6c757d !important;
        }

        /* åŠ è½½å’Œç©ºæ•°æ®çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        /* è‡ªå®šä¹‰è´¹ç”¨é¡¹ */
        .custom-fee-item {
            margin-bottom: 15px;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .table-card-container {
                height: 500px;
            }
            
            .pagination-container {
                flex-direction: column;
                gap: 10px;
                padding: 10px 15px;
            }
            
            .pagination-info {
                margin-right: 0;
                order: 1;
            }
            
            .pagination {
                order: 2;
            }
            
            .page-size-selector {
                order: 3;
            }

            .user-info {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 0.9rem;
            }
        }

        /* æœç´¢è¡¨å•è°ƒæ•´ */
        .search-form .row {
            margin-bottom: 0;
        }

        .search-form .col-md-3 {
            margin-bottom: 10px;
        }

        /* ç™»å½•è¡¨å•æ ·å¼ */
        #loginForm input {
            border-radius: 5px;
            padding: 12px;
            border: 1px solid #ddd;
            transition: border-color 0.3s;
        }

        #loginForm input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(26, 60, 139, 0.25);
        }

        #loginForm .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .login-error {
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 10px;
            text-align: center;
            display: none;
        }

        /* ä¿®å¤ï¼šæ¨¡æ€æ¡†æ ·å¼è°ƒæ•´ */
        .modal-xl-custom {
            max-width: 95%;
            width: 95%;
        }

        @media (min-width: 1200px) {
            .modal-xl-custom {
                max-width: 1140px;
            }
        }

        @media (min-width: 1400px) {
            .modal-xl-custom {
                max-width: 1300px;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-header">
                <h3>è´¦å•ç®¡ç†ç³»ç»Ÿ</h3>
                <p>ä½¿ç”¨ LeanCloud è´¦æˆ·ç™»å½•</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="loginUsername" class="form-label">ç”¨æˆ·å</label>
                    <input type="text" class="form-control" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="mb-3">
                    <label for="loginPassword" class="form-label">å¯†ç </label>
                    <input type="password" class="form-control" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="rememberMe">
                    <label class="form-check-label" for="rememberMe">è®°ä½æˆ‘</label>
                </div>
                <div class="login-error" id="loginError"></div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> ç™»å½•
                    </button>
                </div>
                <div class="mt-3 text-center text-muted">
                    <small>ä½¿ç”¨ LeanCloud _User è¡¨ä¸­çš„è´¦æˆ·ç™»å½•</small>
                </div>
            </form>
        </div>
    </div>

    <!-- ä¸»é¡µé¢å†…å®¹ -->
    <div class="container-fluid" id="mainContent">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page-header">
            <h2>è´¦å•ç®¡ç†ç³»ç»Ÿ</h2>
            <p class="text-muted">è´¹ç”¨è´¦å•ç®¡ç†ä¸ç»Ÿè®¡</p>
        </div>

        <!-- æŸ¥è¯¢æ¡ä»¶ -->
        <div class="card">
            <div class="card-header">
                æŸ¥è¯¢æ¡ä»¶
            </div>
            <div class="card-body">
                <div class="row g-2 search-form">
                    <div class="col-md-3">
                        <label for="billDateRange" class="form-label">è´¦å•æ—¥æœŸ</label>
                        <input type="text" class="form-control date-input" id="billDateRange" placeholder="é€‰æ‹©æ—¥æœŸèŒƒå›´">
                    </div>
                    <div class="col-md-3">
                        <label for="billStatusFilter" class="form-label">è´¦å•çŠ¶æ€</label>
                        <select class="form-select" id="billStatusFilter">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="æœªç¡®è®¤">æœªç¡®è®¤</option>
                            <option value="å·²ç¡®è®¤">å·²ç¡®è®¤</option>
                            <option value="å·²æ”¶æ¬¾">å·²æ”¶æ¬¾</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="companyNameFilter" class="form-label">å…¬å¸åç§°</label>
                        <input type="text" class="form-control" id="companyNameFilter" placeholder="è¾“å…¥å…¬å¸åç§°">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <div class="w-100">
                            <button class="btn btn-primary w-100" id="searchBills">
                                <i class="fas fa-search"></i> æŸ¥è¯¢
                            </button>
                            <button class="btn btn-outline-secondary w-100 mt-1" id="clearBills">
                                <i class="fas fa-undo"></i> æ¸…ç©º
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="row mt-3">
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">æ€»é‡‘é¢</h5>
                        <div class="count text-primary" id="totalAmount">Â¥0.00</div>
                        <p class="card-text">æ‰€æœ‰è´¦å•æ€»é¢</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">æœªç¡®è®¤</h5>
                        <div class="count text-warning" id="unconfirmedAmount">Â¥0.00</div>
                        <p class="card-text">å¾…ç¡®è®¤é‡‘é¢</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">å·²ç¡®è®¤</h5>
                        <div class="count text-info" id="confirmedAmount">Â¥0.00</div>
                        <p class="card-text">å·²ç¡®è®¤é‡‘é¢</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">è´¦å•æ•°é‡</h5>
                        <div class="count text-success" id="billCount">0</div>
                        <p class="card-text">æ€»è´¦å•æ•°</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¡¨æ ¼å’Œåˆ†é¡µç»Ÿä¸€å®¹å™¨ -->
        <div class="table-card-container mt-4">
            <div class="table-card-header d-flex justify-content-between align-items-center">
                <span>è´¦å•åˆ—è¡¨</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" id="importBills">
                        <i class="fas fa-upload"></i> å¯¼å…¥
                    </button>
                    <button class="btn btn-sm btn-outline-success me-2" id="exportBills">
                        <i class="fas fa-download"></i> å¯¼å‡º
                    </button>
                    <button class="btn btn-sm btn-primary" id="generateBill">
                        <i class="fas fa-plus"></i> ç”Ÿæˆè´¦å•
                    </button>
                </div>
            </div>
            
            <div class="table-content-wrapper">
                <!-- è¡¨æ ¼å†…å®¹åŒºåŸŸ -->
                <div class="table-container">
                    <table class="table table-hover" id="billsTable">
                        <thead>
                            <tr>
                                <th>åºå·</th>
                                <th>è´¦å•ç¼–å·</th>
                                <th>è´¦å•æ—¥æœŸ</th>
                                <th>å…¬å¸åç§°</th>
                                <th>æ€»é‡‘é¢</th>
                                <th>å¸ç§</th>
                                <th>è´¦å•çŠ¶æ€</th>
                                <th>æ”¯ä»˜æ—¥æœŸ</th>
                                <th>å¤‡æ³¨</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
                
                <!-- å›ºå®šåœ¨å®¹å™¨åº•éƒ¨çš„åˆ†é¡µæ§ä»¶ -->
                <div class="pagination-container" id="billsPaginationContainer">
                    <div class="pagination-info" id="billsPaginationInfo">
                        å…± 0 é¡µï¼Œæ¯é¡µæ˜¾ç¤º 10 æ¡ï¼Œå…± 0 æ¡è®°å½•
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination" id="billsPagination">
                            <!-- åˆ†é¡µå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </ul>
                    </nav>
                    <div class="page-size-selector">
                        <span>æ¯é¡µæ˜¾ç¤ºï¼š</span>
                        <select class="form-select form-select-sm" id="billsPageSizeSelect">
                            <option value="10">10æ¡</option>
                            <option value="50">50æ¡</option>
                            <option value="100">100æ¡</option>
                            <option value="200">200æ¡</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== æ¨¡æ€æ¡†åŒºåŸŸ ========== -->

    <!-- ç”Ÿæˆè´¦å•æ¨¡æ€æ¡† - ä¿®æ”¹ï¼šä½¿ç”¨è‡ªå®šä¹‰å®½åº¦çš„modal -->
    <div class="modal fade" id="generateBillModal" tabindex="-1" aria-labelledby="generateBillModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="generateBillModalLabel">ç”Ÿæˆè´¦å•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label for="companyName" class="form-label">å…¬å¸åç§° *</label>
                            <input type="text" class="form-control" id="companyName" placeholder="è¾“å…¥å…¬å¸åç§°" required>
                        </div>
                        <div class="col-md-2">
                            <label for="billYear" class="form-label">å¹´ä»½ *</label>
                            <select class="form-select" id="billYear" required>
                                <option value="">é€‰æ‹©å¹´ä»½</option>
                                <!-- å¹´ä»½é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="billMonth" class="form-label">æœˆä»½ *</label>
                            <select class="form-select" id="billMonth" required>
                                <option value="">é€‰æ‹©æœˆä»½</option>
                                <!-- æœˆä»½é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-primary w-100" id="searchCustomsData">
                                <i class="fas fa-search"></i> æŸ¥è¯¢æŠ¥å…³æ•°æ®
                            </button>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label for="searchContainerNo" class="form-label">æŸœå·æŸ¥è¯¢</label>
                            <input type="text" class="form-control" id="searchContainerNo" placeholder="è¾“å…¥æŸœå·">
                        </div>
                        <div class="col-md-4">
                            <label for="searchBillNo" class="form-label">æå•å·æŸ¥è¯¢</label>
                            <input type="text" class="form-control" id="searchBillNo" placeholder="è¾“å…¥æå•å·">
                        </div>
                        <div class="col-md-4">
                            <label for="searchCustomsNo" class="form-label">æŠ¥å…³å•å·æŸ¥è¯¢</label>
                            <input type="text" class="form-control" id="searchCustomsNo" placeholder="è¾“å…¥æŠ¥å…³å•å·">
                        </div>
                    </div>
                    
                    <!-- æŠ¥å…³æ•°æ®è¡¨æ ¼ -->
                    <div class="table-responsive mb-4" style="max-height: 300px;">
                        <table class="table table-sm table-bordered" id="customsDataTable">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">
                                        <input type="checkbox" id="selectAllItems">
                                    </th>
                                    <th>åºå·</th>
                                    <th>åˆ°æ¸¯æ—¥æœŸ</th>
                                    <th>ç”³æŠ¥æ—¥æœŸ</th>
                                    <th>æå•å·</th>
                                    <th>æŸœå·</th>
                                    <th>æŠ¥å…³å•å·</th>
                                    <th>å¢ƒå†…æ”¶å‘è´§äºº</th>
                                    <th>æ¶ˆè´¹ä½¿ç”¨å•ä½</th>
                                    <th>å›½å®¶</th>
                                    <th>å“å</th>
                                </tr>
                            </thead>
                            <tbody id="customsDataBody">
                                <!-- æŠ¥å…³æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- è´¹ç”¨è¾“å…¥åŒºåŸŸ -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>è´¹ç”¨è®¾ç½®</span>
                            <button class="btn btn-sm btn-outline-primary" id="applyAllFees">
                                <i class="fas fa-sync-alt"></i> åº”ç”¨åˆ°æ‰€æœ‰é€‰ä¸­é¡¹
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row g-3" id="feeInputs">
                                <div class="col-md-3">
                                    <label for="customsFee" class="form-label">æŠ¥å…³è´¹</label>
                                    <input type="number" class="form-control fee-input" id="customsFee" step="0.01" min="0" value="0">
                                </div>
                                <div class="col-md-3">
                                    <label for="inspectionFee" class="form-label">æŸ¥éªŒæœåŠ¡è´¹</label>
                                    <input type="number" class="form-control fee-input" id="inspectionFee" step="0.01" min="0" value="0">
                                </div>
                                <div class="col-md-3">
                                    <label for="documentFee" class="form-label">ä»£ç†æ¢å•è´¹</label>
                                    <input type="number" class="form-control fee-input" id="documentFee" step="0.01" min="0" value="0">
                                </div>
                                <div class="col-md-3">
                                    <label for="otherFee1" class="form-label">å…¶ä»–è´¹ç”¨1</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="otherFee1Name" placeholder="è´¹ç”¨åç§°" value="å…¶ä»–è´¹ç”¨1">
                                        <input type="number" class="form-control fee-input" id="otherFee1" step="0.01" min="0" value="0">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="otherFee2" class="form-label">å…¶ä»–è´¹ç”¨2</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="otherFee2Name" placeholder="è´¹ç”¨åç§°" value="å…¶ä»–è´¹ç”¨2">
                                        <input type="number" class="form-control fee-input" id="otherFee2" step="0.01" min="0" value="0">
                                    </div>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-outline-primary w-100" id="addCustomFee">
                                        <i class="fas fa-plus"></i> æ·»åŠ è‡ªå®šä¹‰è´¹ç”¨
                                    </button>
                                </div>
                            </div>
                            
                            <!-- è‡ªå®šä¹‰è´¹ç”¨åŒºåŸŸ -->
                            <div id="customFeesContainer" class="mt-3">
                                <!-- è‡ªå®šä¹‰è´¹ç”¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- è´¦å•é¢„è§ˆ -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>è´¦å•é¢„è§ˆ</span>
                            <div>
                                <!-- æ·»åŠ æœç´¢æ¡† -->
                                <div class="input-group input-group-sm me-2" style="width: 400px;">
                                    <select class="form-select" id="billPreviewSearchType" style="width: 120px;">
                                        <option value="containerNo">æŸœå·</option>
                                        <option value="billNo">æå•å·</option>
                                        <option value="customsNo">æŠ¥å…³å•å·</option>
                                    </select>
                                    <input type="text" class="form-control" id="billPreviewSearch" placeholder="è¾“å…¥æœç´¢å†…å®¹">
                                    <button class="btn btn-outline-secondary" type="button" id="billPreviewSearchBtn">
                                        <i class="fas fa-search"></i> æœç´¢
                                    </button>
                                </div>
                                <button class="btn btn-sm btn-outline-success me-2" id="previewBill">
                                    <i class="fas fa-eye"></i> é¢„è§ˆ
                                </button>
                                <button class="btn btn-sm btn-outline-primary" id="exportBillExcel">
                                    <i class="fas fa-file-excel"></i> å¯¼å‡ºExcel
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="preview-table-container">
                                <table class="table table-sm table-bordered preview-table" id="billPreviewTable">
                                    <thead class="table-light sticky-header">
                                        <tr>
                                            <th>åºå·</th>
                                            <th>åˆ°æ¸¯æ—¶é—´</th>
                                            <th>æå•å·</th>
                                            <th>æŸœå·</th>
                                            <th>æŠ¥å…³è´¹</th>
                                            <th>æŸ¥éªŒæœåŠ¡è´¹</th>
                                            <th>ä»£ç†æ¢å•è´¹</th>
                                            <th id="otherFee1Header">å…¶ä»–è´¹ç”¨1</th>
                                            <th id="otherFee2Header">å…¶ä»–è´¹ç”¨2</th>
                                            <th id="otherFee3Header" style="display: none;">å…¶ä»–è´¹ç”¨3</th>
                                            <th id="otherFee4Header" style="display: none;">å…¶ä»–è´¹ç”¨4</th>
                                            <th>åˆè®¡</th>
                                            <th>å¤‡æ³¨</th>
                                        </tr>
                                    </thead>
                                    <tbody id="billPreviewBody">
                                        <!-- è´¦å•é¢„è§ˆæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-primary">
                                            <td colspan="4" class="text-end"><strong>æ€»è®¡ï¼š</strong></td>
                                            <td id="totalCustomsFee">0.00</td>
                                            <td id="totalInspectionFee">0.00</td>
                                            <td id="totalDocumentFee">0.00</td>
                                            <td id="totalOtherFee1">0.00</td>
                                            <td id="totalOtherFee2">0.00</td>
                                            <td id="totalOtherFee3" style="display: none;">0.00</td>
                                            <td id="totalOtherFee4" style="display: none;">0.00</td>
                                            <td id="grandTotal">0.00</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveGeneratedBill">ä¿å­˜è´¦å•</button>
                    <button type="button" class="btn btn-success" id="exportBillPdf" disabled>
                        <i class="fas fa-file-pdf"></i> å¯¼å‡ºPDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è´¦å•è¯¦æƒ…æ¨¡æ€æ¡† - ä¿®æ”¹ï¼šä½¿ç”¨è‡ªå®šä¹‰å®½åº¦çš„modal -->
    <div class="modal fade" id="billDetailModal" tabindex="-1" aria-labelledby="billDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="billDetailModalLabel">è´¦å•è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>è´¦å•ç¼–å·ï¼š</strong><span id="detailBillNo"></span></p>
                            <p><strong>å…¬å¸åç§°ï¼š</strong><span id="detailCompanyName"></span></p>
                            <p><strong>è´¦å•æ—¥æœŸï¼š</strong><span id="detailBillDate"></span></p>
                            <p><strong>è´¦å•çŠ¶æ€ï¼š</strong><span id="detailBillStatus"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>æ€»é‡‘é¢ï¼š</strong><span id="detailTotalAmount"></span></p>
                            <p><strong>æ”¶æ¬¾æ—¥æœŸï¼š</strong><span id="detailPaymentDate"></span></p>
                            <p><strong>æ”¶æ¬¾æ–¹ï¼š</strong><span id="detailPayee"></span></p>
                            <p><strong>å¤‡æ³¨ï¼š</strong><span id="detailRemark"></span></p>
                        </div>
                    </div>
                    
                    <!-- è´¦å•æ˜ç»† -->
                    <div class="table-responsive mb-4">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>åºå·</th>
                                    <th>åˆ°æ¸¯æ—¶é—´</th>
                                    <th>æå•å·</th>
                                    <th>æŸœå·</th>
                                    <th>æŠ¥å…³å•å·</th>
                                    <th>æŠ¥å…³è´¹</th>
                                    <th>æŸ¥éªŒæœåŠ¡è´¹</th>
                                    <th>ä»£ç†æ¢å•è´¹</th>
                                    <th id="detailOtherFee1Header">å…¶ä»–è´¹ç”¨1</th>
                                    <th id="detailOtherFee2Header">å…¶ä»–è´¹ç”¨2</th>
                                    <th id="detailOtherFee3Header" style="display: none;">å…¶ä»–è´¹ç”¨3</th>
                                    <th id="detailOtherFee4Header" style="display: none;">å…¶ä»–è´¹ç”¨4</th>
                                    <th>åˆè®¡</th>
                                    <th>å¤‡æ³¨</th>
                                </tr>
                            </thead>
                            <tbody id="billDetailItems">
                                <!-- è´¦å•æ˜ç»†å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- é™„ä»¶ç®¡ç† -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>é™„ä»¶ç®¡ç†</span>
                            <button class="btn btn-sm btn-outline-primary" id="uploadInvoiceBtn">
                                <i class="fas fa-upload"></i> ä¸Šä¼ å‘ç¥¨
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="mb-3" id="invoiceUploadSection" style="display: none;">
                                <label for="invoiceUpload" class="form-label">é€‰æ‹©å‘ç¥¨æ–‡ä»¶</label>
                                <input class="form-control" type="file" id="invoiceUpload" accept=".pdf,.jpg,.jpeg,.png">
                                <div class="mt-2">
                                    <button class="btn btn-primary btn-sm" id="confirmUpload">ç¡®è®¤ä¸Šä¼ </button>
                                    <button class="btn btn-secondary btn-sm" id="cancelUpload">å–æ¶ˆ</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>æ–‡ä»¶å</th>
                                            <th>æ–‡ä»¶ç±»å‹</th>
                                            <th>ä¸Šä¼ æ—¶é—´</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invoiceList">
                                        <!-- å‘ç¥¨åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-warning" id="confirmBill">ç¡®è®¤è´¦å•</button>
                    <button type="button" class="btn btn-success" id="exportDetailPdf">
                        <i class="fas fa-file-pdf"></i> å¯¼å‡ºPDF
                    </button>
                    <button type="button" class="btn btn-outline-success" id="exportDetailExcel">
                        <i class="fas fa-file-excel"></i> å¯¼å‡ºExcel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== å¼•å…¥JavaScriptåº“ ========== -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- é…ç½®æ–‡ä»¶ - å¿…é¡»åœ¨ä¸»è„šæœ¬ä¹‹å‰åŠ è½½ -->
    <script src="config.js"></script>

    <!-- ========== è´¦å•ç®¡ç†JavaScriptä»£ç  ========== -->
    <script>
        // æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦åŠ è½½æˆåŠŸ
        if (typeof window.APP_CONFIG === 'undefined') {
            console.error('âŒ é…ç½®æ–‡ä»¶æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ config.js æ–‡ä»¶æ˜¯å¦å­˜åœ¨');
            alert('ç³»ç»Ÿé…ç½®é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
        } else {
            console.log('âœ… é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ', window.APP_CONFIG);
        }

        // è´¦å•ç®¡ç†åŠŸèƒ½æ¨¡å—
        let billsData = [];
        let filteredBillsData = [];
        let customsDataForBilling = [];
        let selectedItemsForBill = [];
        let billsItemsPerPage = 10;
        let billsCurrentPageIndex = 1;
        let billsTotalPages = 1;
        let customFees = [];
        let currentCustomFeeId = 3; // ä»3å¼€å§‹ï¼Œå› ä¸º1å’Œ2å·²ç»è¢«å…¶ä»–è´¹ç”¨1å’Œ2å ç”¨
        
        // æœç´¢ç›¸å…³å˜é‡
        let searchBillQuery = '';
        let searchBillType = 'containerNo';
        
        // ç”¨æˆ·ç®¡ç†ç›¸å…³å˜é‡
        let currentUser = null;
        let isLoggedIn = false;

        // LeanCloudåˆå§‹åŒ– - ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„å€¼
        if (window.APP_CONFIG) {
            AV.init({
                appId: window.APP_CONFIG.LEANCLOUD_APP_ID,
                appKey: window.APP_CONFIG.LEANCLOUD_APP_KEY,
                serverURL: window.APP_CONFIG.LEANCLOUD_SERVER_URL
            });
            console.log('ğŸ” LeanCloud åˆå§‹åŒ–å®Œæˆ');
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ - ä¿®å¤ç‰ˆæœ¬
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€');
            
            // ç¡®ä¿ç™»å½•é¡µé¢åˆå§‹çŠ¶æ€æ­£ç¡®
            const loginContainer = document.getElementById('loginContainer');
            const mainContent = document.getElementById('mainContent');
            
            if (loginContainer && mainContent) {
                console.log('æ‰¾åˆ°ç™»å½•é¡µé¢å’Œä¸»é¡µé¢å…ƒç´ ');
                
                // åˆå§‹çŠ¶æ€ï¼šç™»å½•é¡µé¢æ˜¾ç¤ºï¼Œä¸»é¡µé¢éšè—
                loginContainer.style.display = 'flex';
                mainContent.style.display = 'none';
                
                // å»¶è¿Ÿæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
                setTimeout(() => {
                    checkLoginStatus();
                }, 100);
            } else {
                console.error('æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ');
            }
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            try {
                currentUser = AV.User.current();
                
                console.log('æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œå½“å‰ç”¨æˆ·:', currentUser);
                
                if (currentUser) {
                    // éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆ
                    await currentUser.isAuthenticated();
                    isLoggedIn = true;
                    console.log('ç”¨æˆ·å·²ç™»å½•ï¼Œæ˜¾ç¤ºä¸»é¡µé¢');
                    showMainContent();
                } else {
                    console.log('ç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢');
                    showLoginPage();
                }
            } catch (error) {
                console.log('Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•:', error);
                showLoginPage();
            }
        }

        // æ˜¾ç¤ºç™»å½•é¡µé¢ - ä¿®å¤ç‰ˆæœ¬
        function showLoginPage() {
            console.log('æ˜¾ç¤ºç™»å½•é¡µé¢');
            
            // ç¡®ä¿ä¸»é¡µé¢éšè—
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.style.display = 'none';
            }
            
            // ç¡®ä¿ç™»å½•é¡µé¢æ˜¾ç¤º
            const loginContainer = document.getElementById('loginContainer');
            if (loginContainer) {
                loginContainer.style.display = 'flex';
            }
            
            // è‡ªåŠ¨å¡«å……ä¸Šæ¬¡ç™»å½•çš„ç”¨æˆ·å
            const lastUsername = localStorage.getItem('lastUsername');
            if (lastUsername) {
                document.getElementById('loginUsername').value = lastUsername;
            }
            
            // ç»‘å®šè®°ä½æˆ‘å¤é€‰æ¡†
            const rememberMe = document.getElementById('rememberMe');
            const savedRemember = localStorage.getItem('rememberMe') === 'true';
            rememberMe.checked = savedRemember;
            
            // ç»‘å®šç™»å½•è¡¨å•äº‹ä»¶ - ä½¿ç”¨ä¸€æ¬¡æ€§äº‹ä»¶ç›‘å¬
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                // ç§»é™¤æ‰€æœ‰ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨
                const newLoginForm = loginForm.cloneNode(true);
                loginForm.parentNode.replaceChild(newLoginForm, loginForm);
                
                // é‡æ–°ç»‘å®šäº‹ä»¶
                document.getElementById('loginForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ç™»å½•è¡¨å•æäº¤');
                    login();
                    return false;
                });
            }
            
            // ç„¦ç‚¹è®¾ç½®åœ¨å¯†ç è¾“å…¥æ¡†
            if (lastUsername && lastUsername.trim() !== '') {
                document.getElementById('loginPassword').focus();
            } else {
                document.getElementById('loginUsername').focus();
            }
        }

        // æ˜¾ç¤ºä¸»é¡µé¢ - ä¿®å¤ç‰ˆæœ¬
        function showMainContent() {
            console.log('æ˜¾ç¤ºä¸»é¡µé¢');
            
            // ç¡®ä¿ç™»å½•é¡µé¢éšè—
            const loginContainer = document.getElementById('loginContainer');
            if (loginContainer) {
                loginContainer.style.display = 'none';
            }
            
            // ç¡®ä¿ä¸»é¡µé¢æ˜¾ç¤º
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.style.display = 'block';
            } else {
                console.error('æ‰¾ä¸åˆ°ä¸»é¡µé¢å…ƒç´ ');
            }
            
            // åˆ›å»ºç”¨æˆ·ä¿¡æ¯æ 
            createUserInfoBar();
            
            // åˆå§‹åŒ–åŠŸèƒ½ - ä½¿ç”¨setTimeoutç¡®ä¿DOMæ›´æ–°
            setTimeout(() => {
                try {
                    initDatePickers();
                    bindEvents();
                    loadListData();
                } catch (error) {
                    console.error('åˆå§‹åŒ–åŠŸèƒ½å¤±è´¥:', error);
                }
            }, 100);
        }

        // åˆ›å»ºç”¨æˆ·ä¿¡æ¯æ 
        function createUserInfoBar() {
            // ç§»é™¤ç°æœ‰çš„ç”¨æˆ·ä¿¡æ¯æ 
            const existingUserInfo = document.querySelector('.user-info');
            if (existingUserInfo) {
                existingUserInfo.remove();
            }
            
            if (!currentUser) return;
            
            const userInfoBar = document.createElement('div');
            userInfoBar.className = 'user-info';
            userInfoBar.innerHTML = `
                <span class="username">${currentUser.get('username') || currentUser.get('email') || 'ç”¨æˆ·'}</span>
                <button class="btn btn-sm btn-outline-danger logout-btn">
                    <i class="fas fa-sign-out-alt"></i> é€€å‡ºç™»å½•
                </button>
            `;
            
            document.body.appendChild(userInfoBar);
            
            // ç»‘å®šé€€å‡ºæŒ‰é’®äº‹ä»¶
            userInfoBar.querySelector('.logout-btn').addEventListener('click', logout);
        }

        // ç™»å½•å‡½æ•° - ä¿®å¤ç‰ˆæœ¬
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const loginBtn = document.getElementById('loginBtn');
            const errorElement = document.getElementById('loginError');
            
            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
            errorElement.style.display = 'none';
            errorElement.textContent = '';
            
            if (!username || !password) {
                showLoginError('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            // ç¦ç”¨ç™»å½•æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loginBtn.disabled = true;
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç™»å½•ä¸­...';
            
            try {
                // LeanCloud ç™»å½•
                currentUser = await AV.User.logIn(username, password);
                isLoggedIn = true;
                
                // ä¿å­˜ç™»å½•ä¿¡æ¯
                localStorage.setItem('lastUsername', username);
                localStorage.setItem('rememberMe', rememberMe);
                
                // æ˜¾ç¤ºä¸»é¡µé¢ - ç¡®ä¿æ‰§è¡Œ
                console.log('ç™»å½•æˆåŠŸï¼Œåˆ‡æ¢åˆ°ä¸»é¡µé¢');
                showMainContent();
                
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                let errorMessage = 'ç™»å½•å¤±è´¥';
                
                if (error.code === 211) {
                    errorMessage = 'ç”¨æˆ·ä¸å­˜åœ¨';
                } else if (error.code === 210) {
                    errorMessage = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
                } else if (error.code === 219) {
                    errorMessage = 'ç™»å½•å¤±è´¥æ¬¡æ•°è¶…è¿‡é™åˆ¶ï¼Œè¯·ç¨åå†è¯•';
                } else {
                    errorMessage = `ç™»å½•å¤±è´¥: ${error.message}`;
                }
                
                showLoginError(errorMessage);
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
            } finally {
                // æ¢å¤ç™»å½•æŒ‰é’®çŠ¶æ€
                loginBtn.disabled = false;
                loginBtn.innerHTML = originalText;
            }
        }

        // æ˜¾ç¤ºç™»å½•é”™è¯¯
        function showLoginError(message) {
            const errorElement = document.getElementById('loginError');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—é”™è¯¯ä¿¡æ¯
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 3000);
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                return;
            }
            
            try {
                await AV.User.logOut();
                currentUser = null;
                isLoggedIn = false;
                
                // ç§»é™¤ç”¨æˆ·ä¿¡æ¯æ 
                const userInfoBar = document.querySelector('.user-info');
                if (userInfoBar) {
                    userInfoBar.remove();
                }
                
                // æ¸…ç©ºæ•°æ®
                billsData = [];
                filteredBillsData = [];
                
                // æ˜¾ç¤ºç™»å½•é¡µé¢
                showLoginPage();
                
                // æ¸…ç©ºä¸»é¡µé¢å†…å®¹
                const tbody = document.querySelector('#billsTable tbody');
                if (tbody) {
                    tbody.innerHTML = '';
                }
                
                // é‡ç½®ç»Ÿè®¡ä¿¡æ¯
                updateStatistics();
                
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                alert('é€€å‡ºç™»å½•å¤±è´¥');
            }
        }

        // æ£€æŸ¥æ˜¯å¦ç™»å½•
        function checkLogin() {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•ç³»ç»Ÿ');
                logout(); // è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢
                return false;
            }
            return true;
        }

        // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
        function initDatePickers() {
            const billDatePicker = flatpickr('#billDateRange', {
                mode: 'range',
                locale: 'zh',
                dateFormat: 'Y-m-d',
                allowInput: true
            });
            
            window.datePickers = {
                billDateRange: billDatePicker
            };
        }

        // ç»‘å®šæ‰€æœ‰äº‹ä»¶
        function bindEvents() {
            // æŸ¥è¯¢æŒ‰é’®
            document.getElementById('searchBills').addEventListener('click', function() {
                if (!checkLogin()) return;
                loadListData();
            });
            
            // æ¸…ç©ºæŒ‰é’®
            document.getElementById('clearBills').addEventListener('click', function() {
                if (!checkLogin()) return;
                clearBills();
            });
            
            // æ¯é¡µæ˜¾ç¤ºæ¡æ•°å˜åŒ–
            document.getElementById('billsPageSizeSelect').addEventListener('change', function() {
                billsItemsPerPage = parseInt(this.value);
                billsCurrentPageIndex = 1;
                updateBillsPagination();
                renderBillsTable();
            });
            
            // ç”Ÿæˆè´¦å•æŒ‰é’®
            document.getElementById('generateBill').addEventListener('click', function() {
                if (!checkLogin()) return;
                showGenerateBillModal();
            });
            
            // æŸ¥è¯¢æŠ¥å…³æ•°æ®æŒ‰é’®
            document.getElementById('searchCustomsData').addEventListener('click', function() {
                if (!checkLogin()) return;
                searchCustomsData();
            });
            
            // åº”ç”¨åˆ°æ‰€æœ‰é€‰ä¸­é¡¹æŒ‰é’®
            document.getElementById('applyAllFees').addEventListener('click', function() {
                if (!checkLogin()) return;
                applyAllFees();
            });
            
            // é¢„è§ˆè´¦å•æŒ‰é’® - ä¿®å¤ï¼šæ·»åŠ  preventDefault
            document.getElementById('previewBill').addEventListener('click', function(e) {
                e.preventDefault();
                if (!checkLogin()) return;
                previewBill();
            });
            
            // ä¿å­˜ç”Ÿæˆè´¦å•æŒ‰é’®
            document.getElementById('saveGeneratedBill').addEventListener('click', function() {
                if (!checkLogin()) return;
                saveGeneratedBill();
            });
            
            // å¯¼å‡ºExcelæŒ‰é’®
            document.getElementById('exportBillExcel').addEventListener('click', function() {
                if (!checkLogin()) return;
                exportBillExcel();
            });
            
            // å¯¼å‡ºPDFæŒ‰é’®
            document.getElementById('exportBillPdf').addEventListener('click', function() {
                if (!checkLogin()) return;
                exportBillPdf();
            });
            
            // æ·»åŠ è‡ªå®šä¹‰è´¹ç”¨æŒ‰é’®
            document.getElementById('addCustomFee').addEventListener('click', function() {
                if (!checkLogin()) return;
                addCustomFee();
            });
            
            // ç¡®è®¤è´¦å•æŒ‰é’®
            document.getElementById('confirmBill').addEventListener('click', function() {
                if (!checkLogin()) return;
                confirmBill();
            });
            
            // å¯¼å‡ºè¯¦æƒ…PDFæŒ‰é’®
            document.getElementById('exportDetailPdf').addEventListener('click', function() {
                if (!checkLogin()) return;
                exportDetailPdf();
            });
            
            // å¯¼å‡ºè¯¦æƒ…ExcelæŒ‰é’®
            document.getElementById('exportDetailExcel').addEventListener('click', function() {
                if (!checkLogin()) return;
                const billId = document.getElementById('billDetailModal').getAttribute('data-current-id');
                const item = billsData.find(item => item.id === billId);
                if (item) {
                    exportDetailExcel(item);
                }
            });
            
            // ä¸Šä¼ å‘ç¥¨æŒ‰é’®
            document.getElementById('uploadInvoiceBtn').addEventListener('click', function() {
                if (!checkLogin()) return;
                showUploadInvoice();
            });
            
            // ç¡®è®¤ä¸Šä¼ æŒ‰é’®
            document.getElementById('confirmUpload').addEventListener('click', function() {
                if (!checkLogin()) return;
                confirmUploadInvoice();
            });
            
            // å–æ¶ˆä¸Šä¼ æŒ‰é’®
            document.getElementById('cancelUpload').addEventListener('click', function() {
                if (!checkLogin()) return;
                cancelUpload();
            });
            
            // è´¦å•é¢„è§ˆæœç´¢æŒ‰é’®
            document.getElementById('billPreviewSearchBtn').addEventListener('click', function() {
                if (!checkLogin()) return;
                searchBillPreview();
            });
            
            // è´¦å•é¢„è§ˆæœç´¢è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            document.getElementById('billPreviewSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    if (!checkLogin()) return;
                    searchBillPreview();
                }
            });
            
            // ç»‘å®šè´¹ç”¨è¾“å…¥å˜åŒ–äº‹ä»¶
            document.querySelectorAll('.fee-input').forEach(input => {
                input.addEventListener('change', function() {
                    if (selectedItemsForBill.length > 0) {
                        previewBill();
                    }
                });
            });
            
            // ç»‘å®šè´¹ç”¨åç§°å˜åŒ–äº‹ä»¶
            document.getElementById('otherFee1Name').addEventListener('change', function() {
                if (selectedItemsForBill.length > 0) {
                    previewBill();
                }
            });
            
            document.getElementById('otherFee2Name').addEventListener('change', function() {
                if (selectedItemsForBill.length > 0) {
                    previewBill();
                }
            });
        }

        // åŠ è½½è´¦å•æ•°æ®
        async function loadListData() {
            if (!checkLogin()) return;
            
            try {
                const tbody = document.querySelector('#billsTable tbody');
                if (!tbody) {
                    console.warn('è´¦å•ç®¡ç†è¡¨æ ¼å…ƒç´ å°šæœªåŠ è½½');
                    return;
                }
                
                tbody.innerHTML = '<tr><td colspan="10" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</td></tr>';
                
                // æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
                const tableExists = await checkTableExists('Bills');
                if (!tableExists) {
                    tbody.innerHTML = '<tr><td colspan="10" class="no-data">è´¦å•è¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆåœ¨LeanCloudåå°åˆ›å»ºBillsè¡¨</td></tr>';
                    updateStatistics();
                    return;
                }
                
                const query = new AV.Query('Bills');
                query.descending('billDate');
                const results = await query.find();
                
                billsData = results.map(item => {
                    const data = item.toJSON();
                    return {
                        id: data.objectId,
                        billNo: data.billNo || generateBillNo(),
                        billDate: data.billDate || '',
                        companyName: data.companyName || '',
                        containerNo: data.containerNo || '',
                        customsNo: data.customsNo || '',
                        billNoSearch: data.billNoSearch || '',
                        domesticConsignee: data.domesticConsignee || '',
                        totalAmount: data.totalAmount || 0,
                        currency: data.currency || 'CNY',
                        billStatus: data.billStatus || 'æœªç¡®è®¤',
                        paymentDate: data.paymentDate || '',
                        payee: data.payee || '',
                        remark: data.remark || '',
                        billItems: data.billItems || [],
                        attachments: data.attachments || [],
                        customFees: data.customFees || [],
                        leanCloudObject: item
                    };
                });
                
                applyBillsFilters();
                billsCurrentPageIndex = 1;
                updateBillsPagination();
                renderBillsTable();
                updateStatistics();
                
            } catch (error) {
                console.error('åŠ è½½è´¦å•æ•°æ®å¤±è´¥:', error);
                const tbody = document.querySelector('#billsTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="10" class="no-data">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</td></tr>';
                }
                updateStatistics();
            }
        }

        // ç”Ÿæˆè´¦å•ç¼–å·
        function generateBillNo() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `BILL${year}${month}${day}${random}`;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics() {
            const totalAmount = filteredBillsData.reduce((sum, bill) => sum + (parseFloat(bill.totalAmount) || 0), 0);
            const unconfirmedAmount = filteredBillsData
                .filter(bill => bill.billStatus === 'æœªç¡®è®¤')
                .reduce((sum, bill) => sum + (parseFloat(bill.totalAmount) || 0), 0);
            const confirmedAmount = filteredBillsData
                .filter(bill => bill.billStatus === 'å·²ç¡®è®¤')
                .reduce((sum, bill) => sum + (parseFloat(bill.totalAmount) || 0), 0);
            
            document.getElementById('totalAmount').textContent = `Â¥${totalAmount.toFixed(2)}`;
            document.getElementById('unconfirmedAmount').textContent = `Â¥${unconfirmedAmount.toFixed(2)}`;
            document.getElementById('confirmedAmount').textContent = `Â¥${confirmedAmount.toFixed(2)}`;
            document.getElementById('billCount').textContent = filteredBillsData.length;
        }

        // åº”ç”¨è´¦å•ç­›é€‰æ¡ä»¶
        function applyBillsFilters() {
            const billDateRange = document.getElementById('billDateRange').value;
            const billStatus = document.getElementById('billStatusFilter').value;
            const companyName = document.getElementById('companyNameFilter').value;
            
            filteredBillsData = billsData.filter(item => {
                let match = true;
                
                if (billStatus && billStatus.trim() !== '') {
                    if (item.billStatus !== billStatus) {
                        match = false;
                    }
                }
                
                if (companyName && companyName.trim() !== '') {
                    if (!item.companyName || !item.companyName.includes(companyName)) {
                        match = false;
                    }
                }
                
                if (billDateRange && billDateRange.trim() !== '') {
                    const separator = billDateRange.includes('è‡³') ? 'è‡³' : 'to';
                    const dates = billDateRange.split(separator).map(date => date.trim());
                    
                    if (dates.length === 2) {
                        const startDateStr = dates[0];
                        const endDateStr = dates[1];
                        
                        if (!item.billDate || item.billDate.trim() === '') {
                            match = false;
                        } else {
                            const itemDate = new Date(item.billDate);
                            const startDate = new Date(startDateStr);
                            const endDate = new Date(endDateStr);
                            
                            if (isNaN(itemDate.getTime()) || isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                                match = false;
                            } else {
                                const itemDateOnly = new Date(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate());
                                const startDateOnly = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                                const endDateOnly = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
                                
                                if (itemDateOnly < startDateOnly || itemDateOnly > endDateOnly) {
                                    match = false;
                                }
                            }
                        }
                    }
                }
                
                return match;
            });
        }

        // æ¸²æŸ“è´¦å•è¡¨æ ¼
        function renderBillsTable() {
            const tbody = document.querySelector('#billsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (filteredBillsData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="10" class="text-center no-data">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•°æ®</td>`;
                tbody.appendChild(row);
                return;
            }
            
            const startIndex = (billsCurrentPageIndex - 1) * billsItemsPerPage;
            const endIndex = Math.min(startIndex + billsItemsPerPage, filteredBillsData.length);
            const currentPageData = filteredBillsData.slice(startIndex, endIndex);
            
            currentPageData.forEach((item, index) => {
                const row = document.createElement('tr');
                const globalIndex = startIndex + index;
                
                // æ ¹æ®çŠ¶æ€è®¾ç½®è¡Œæ ·å¼
                let rowClass = '';
                if (item.billStatus === 'æœªç¡®è®¤') {
                    rowClass = 'table-warning';
                } else if (item.billStatus === 'å·²ç¡®è®¤') {
                    rowClass = 'table-info';
                } else if (item.billStatus === 'å·²æ”¶æ¬¾') {
                    rowClass = 'table-success';
                }
                
                row.innerHTML = `
                    <td>${globalIndex + 1}</td>
                    <td>${item.billNo}</td>
                    <td>${item.billDate}</td>
                    <td>${item.companyName}</td>
                    <td class="fw-bold">${formatCurrency(item.totalAmount || 0, item.currency)}</td>
                    <td>${item.currency}</td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(item.billStatus)}">${item.billStatus}</span>
                    </td>
                    <td>${item.paymentDate || '-'}</td>
                    <td>${item.remark || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-bill" data-id="${item.id}">
                            <i class="fas fa-eye"></i> æŸ¥çœ‹
                        </button>
                        ${item.billStatus !== 'å·²æ”¶æ¬¾' ? `
                        <button class="btn btn-sm btn-outline-danger delete-bill" data-id="${item.id}">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                        ` : ''}
                    </td>
                `;
                
                if (rowClass) {
                    row.className = rowClass;
                }
                
                tbody.appendChild(row);
            });
            
            bindBillsEvents();
            updateBillsPaginationInfo();
        }

        // æ ¼å¼åŒ–è´§å¸æ˜¾ç¤º
        function formatCurrency(amount, currency) {
            const numAmount = parseFloat(amount) || 0;
            const symbol = getCurrencySymbol(currency);
            return `${symbol}${numAmount.toFixed(2)}`;
        }

        // è·å–è´§å¸ç¬¦å·
        function getCurrencySymbol(currency) {
            const symbols = {
                'CNY': 'Â¥',
                'USD': '$',
                'EUR': 'â‚¬',
                'JPY': 'Â¥'
            };
            return symbols[currency] || currency;
        }

        // è·å–çŠ¶æ€æ ‡ç­¾æ ·å¼
        function getStatusBadgeClass(status) {
            const classes = {
                'æœªç¡®è®¤': 'bg-warning',
                'å·²ç¡®è®¤': 'bg-info',
                'å·²æ”¶æ¬¾': 'bg-success'
            };
            return classes[status] || 'bg-secondary';
        }

        // ç»‘å®šè´¦å•äº‹ä»¶
        function bindBillsEvents() {
            // æŸ¥çœ‹è´¦å•è¯¦æƒ…
            document.querySelectorAll('.view-bill').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!checkLogin()) return;
                    const id = this.getAttribute('data-id');
                    showBillDetail(id);
                });
            });
            
            // åˆ é™¤è´¦å•
            document.querySelectorAll('.delete-bill').forEach(btn => {
                btn.addEventListener('click', async function() {
                    if (!checkLogin()) return;
                    const id = this.getAttribute('data-id');
                    await deleteBill(id);
                });
            });
        }

        // æ˜¾ç¤ºç”Ÿæˆè´¦å•æ¨¡æ€æ¡†
        function showGenerateBillModal() {
            // æ¸…ç©ºè¡¨å•
            const form = document.querySelector('#generateBillModal form');
            if (form) form.reset();
            
            // åˆå§‹åŒ–å¹´ä»½å’Œæœˆä»½é€‰æ‹©
            initYearMonthSelectors();
            
            // æ¸…ç©ºé€‰æ‹©çš„æ•°æ®
            selectedItemsForBill = [];
            customsDataForBilling = [];
            customFees = [];
            currentCustomFeeId = 3;
            
            // æ¸…ç©ºæœç´¢æ¡ä»¶
            searchBillQuery = '';
            searchBillType = 'containerNo';
            
            // æ¸…ç©ºè¡¨æ ¼
            document.getElementById('customsDataBody').innerHTML = '';
            document.getElementById('billPreviewBody').innerHTML = '';
            
            // é‡ç½®è´¹ç”¨è¾“å…¥
            document.getElementById('customsFee').value = '0';
            document.getElementById('inspectionFee').value = '0';
            document.getElementById('documentFee').value = '0';
            document.getElementById('otherFee1').value = '0';
            document.getElementById('otherFee2').value = '0';
            document.getElementById('otherFee1Name').value = 'å…¶ä»–è´¹ç”¨1';
            document.getElementById('otherFee2Name').value = 'å…¶ä»–è´¹ç”¨2';
            
            // æ¸…ç©ºè‡ªå®šä¹‰è´¹ç”¨åŒºåŸŸ
            document.getElementById('customFeesContainer').innerHTML = '';
            
            // æ›´æ–°å…¶ä»–è´¹ç”¨è¡¨å¤´
            document.getElementById('otherFee1Header').textContent = 'å…¶ä»–è´¹ç”¨1';
            document.getElementById('otherFee2Header').textContent = 'å…¶ä»–è´¹ç”¨2';
            document.getElementById('otherFee3Header').style.display = 'none';
            document.getElementById('otherFee4Header').style.display = 'none';
            document.getElementById('totalOtherFee3').style.display = 'none';
            document.getElementById('totalOtherFee4').style.display = 'none';
            
            // é‡ç½®æ€»è®¡
            document.getElementById('totalCustomsFee').textContent = '0.00';
            document.getElementById('totalInspectionFee').textContent = '0.00';
            document.getElementById('totalDocumentFee').textContent = '0.00';
            document.getElementById('totalOtherFee1').textContent = '0.00';
            document.getElementById('totalOtherFee2').textContent = '0.00';
            document.getElementById('grandTotal').textContent = '0.00';
            
            // é‡æ–°ç»‘å®šé¢„è§ˆæŒ‰é’®äº‹ä»¶
            document.getElementById('previewBill').addEventListener('click', function(e) {
                e.preventDefault();
                if (!checkLogin()) return;
                previewBill();
            });
            
            const modal = new bootstrap.Modal(document.getElementById('generateBillModal'));
            modal.show();
        }

        // åˆå§‹åŒ–å¹´ä»½å’Œæœˆä»½é€‰æ‹©å™¨
        function initYearMonthSelectors() {
            const yearSelect = document.getElementById('billYear');
            const monthSelect = document.getElementById('billMonth');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            yearSelect.innerHTML = '<option value="">é€‰æ‹©å¹´ä»½</option>';
            monthSelect.innerHTML = '<option value="">é€‰æ‹©æœˆä»½</option>';
            
            // æ·»åŠ å¹´ä»½é€‰é¡¹ï¼ˆå½“å‰å¹´ä»½åŠå‰å5å¹´ï¼‰
            const currentYear = new Date().getFullYear();
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'å¹´';
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
            
            // æ·»åŠ æœˆä»½é€‰é¡¹
            for (let month = 1; month <= 12; month++) {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month + 'æœˆ';
                if (month === new Date().getMonth() + 1) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            }
        }

        // æŸ¥è¯¢æŠ¥å…³æ•°æ®
        async function searchCustomsData() {
            if (!checkLogin()) return;
            
            const companyName = document.getElementById('companyName').value;
            const year = document.getElementById('billYear').value;
            const month = document.getElementById('billMonth').value;
            
            if (!companyName || !year || !month) {
                alert('è¯·å¡«å†™å…¬å¸åç§°ã€å¹´ä»½å’Œæœˆä»½');
                return;
            }
            
            try {
                // æŸ¥è¯¢æŠ¥å…³æ•°æ® - æŒ‰ç”³æŠ¥æ—¥æœŸç­›é€‰
                const query = new AV.Query('Tracking');
                
                // æ·»åŠ æŸ¥è¯¢æ¡ä»¶ï¼šæŒ‰ç”³æŠ¥æ—¥æœŸç­›é€‰
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0);
                
                query.greaterThanOrEqualTo('declareDate', startDate.toISOString().split('T')[0]);
                query.lessThanOrEqualTo('declareDate', endDate.toISOString().split('T')[0]);
                
                query.ascending('declareDate');
                const results = await query.find();
                
                customsDataForBilling = results.map(item => {
                    const data = item.toJSON();
                    return {
                        id: data.objectId,
                        arrivalDate: data.arrivalDate || '',
                        declareDate: data.declareDate || '',
                        billNo: data.billNo || '',
                        containerNo: data.containerNo || '',
                        customsNo: data.customsNo || '',
                        domesticConsignee: data.domesticConsignee || '',
                        consumptionUnit: data.consumptionUnit || '',
                        country: data.country || '',
                        productName: data.productName || '',
                        selected: false,
                        leanCloudObject: item
                    };
                });
                
                // è¿‡æ»¤æ‰å·²ç»åœ¨è´¦å•ä¸­çš„æ•°æ®
                await filterUsedCustomsData();
                
                // åº”ç”¨æŸ¥è¯¢æ¡ä»¶
                applyCustomsDataFilters();
                
                // æ¸²æŸ“æŠ¥å…³æ•°æ®è¡¨æ ¼
                renderCustomsDataTable();
                
            } catch (error) {
                console.error('æŸ¥è¯¢æŠ¥å…³æ•°æ®å¤±è´¥:', error);
                alert('æŸ¥è¯¢æŠ¥å…³æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // è¿‡æ»¤æ‰å·²ç»åœ¨è´¦å•ä¸­ä½¿ç”¨çš„æŠ¥å…³æ•°æ®
        async function filterUsedCustomsData() {
            try {
                // æŸ¥è¯¢å·²ç”Ÿæˆè´¦å•çš„æ•°æ®
                const billQuery = new AV.Query('Bills');
                const billResults = await billQuery.find();
                
                const usedIds = new Set();
                billResults.forEach(bill => {
                    const billData = bill.toJSON();
                    if (billData.billItems) {
                        billData.billItems.forEach(item => {
                            if (item.customsDataId) {
                                usedIds.add(item.customsDataId);
                            }
                        });
                    }
                });
                
                // è¿‡æ»¤æ‰å·²ä½¿ç”¨çš„æ•°æ®
                customsDataForBilling = customsDataForBilling.filter(item => !usedIds.has(item.id));
                
            } catch (error) {
                console.error('è¿‡æ»¤å·²ä½¿ç”¨æ•°æ®å¤±è´¥:', error);
            }
        }

        // åº”ç”¨æŠ¥å…³æ•°æ®ç­›é€‰æ¡ä»¶
        function applyCustomsDataFilters() {
            const containerNo = document.getElementById('searchContainerNo').value;
            const billNo = document.getElementById('searchBillNo').value;
            const customsNo = document.getElementById('searchCustomsNo').value;
            
            if (containerNo || billNo || customsNo) {
                customsDataForBilling = customsDataForBilling.filter(item => {
                    let match = true;
                    
                    if (containerNo && containerNo.trim() !== '') {
                        if (!item.containerNo || !item.containerNo.includes(containerNo)) {
                            match = false;
                        }
                    }
                    
                    if (billNo && billNo.trim() !== '') {
                        if (!item.billNo || !item.billNo.includes(billNo)) {
                            match = false;
                        }
                    }
                    
                    if (customsNo && customsNo.trim() !== '') {
                        if (!item.customsNo || !item.customsNo.includes(customsNo)) {
                            match = false;
                        }
                    }
                    
                    return match;
                });
            }
        }

        // æ¸²æŸ“æŠ¥å…³æ•°æ®è¡¨æ ¼
        function renderCustomsDataTable() {
            const tbody = document.getElementById('customsDataBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (customsDataForBilling.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center">æ²¡æœ‰æ‰¾åˆ°æŠ¥å…³æ•°æ®</td></tr>';
                return;
            }
            
            customsDataForBilling.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="item-checkbox" data-id="${item.id}" ${item.selected ? 'checked' : ''}>
                    </td>
                    <td>${index + 1}</td>
                    <td>${item.arrivalDate}</td>
                    <td>${item.declareDate}</td>
                    <td>${item.billNo}</td>
                    <td>${item.containerNo}</td>
                    <td>${item.customsNo}</td>
                    <td>${item.domesticConsignee}</td>
                    <td>${item.consumptionUnit}</td>
                    <td>${item.country}</td>
                    <td>${item.productName}</td>
                `;
                tbody.appendChild(row);
            });
            
            // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
            bindCustomsDataCheckboxes();
        }

        // ç»‘å®šæŠ¥å…³æ•°æ®å¤é€‰æ¡†äº‹ä»¶
        function bindCustomsDataCheckboxes() {
            document.querySelectorAll('.item-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const id = this.getAttribute('data-id');
                    const item = customsDataForBilling.find(item => item.id === id);
                    if (item) {
                        item.selected = this.checked;
                    }
                    
                    // æ›´æ–°å…¨é€‰çŠ¶æ€
                    updateSelectAllCheckbox();
                    
                    // æ›´æ–°å·²é€‰æ‹©é¡¹ç›®
                    selectedItemsForBill = customsDataForBilling.filter(item => item.selected);
                });
            });
            
            // å…¨é€‰å¤é€‰æ¡†
            const selectAllCheckbox = document.getElementById('selectAllItems');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.item-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                        const id = checkbox.getAttribute('data-id');
                        const item = customsDataForBilling.find(item => item.id === id);
                        if (item) {
                            item.selected = this.checked;
                        }
                    });
                    
                    selectedItemsForBill = this.checked ? [...customsDataForBilling] : [];
                });
            }
        }

        // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAllItems');
            if (!selectAllCheckbox) return;
            
            const checkboxes = document.querySelectorAll('.item-checkbox');
            const checkedCount = document.querySelectorAll('.item-checkbox:checked').length;
            
            selectAllCheckbox.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        }

        // æ·»åŠ è‡ªå®šä¹‰è´¹ç”¨
        function addCustomFee() {
            const customFeesContainer = document.getElementById('customFeesContainer');
            
            // æœ€å¤šæ”¯æŒ4ä¸ªå…¶ä»–è´¹ç”¨
            if (currentCustomFeeId > 4) {
                alert('æœ€å¤šåªèƒ½æ·»åŠ 4ä¸ªå…¶ä»–è´¹ç”¨');
                return;
            }
            
            const feeId = currentCustomFeeId;
            const feeHtml = `
                <div class="custom-fee-item" id="customFee${feeId}">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label">å…¶ä»–è´¹ç”¨${feeId}</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="otherFee${feeId}Name" placeholder="è´¹ç”¨åç§°" value="å…¶ä»–è´¹ç”¨${feeId}">
                                <input type="number" class="form-control fee-input" id="otherFee${feeId}" step="0.01" min="0" value="0">
                                <button class="btn btn-outline-danger" type="button" onclick="removeCustomFee(${feeId})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            customFeesContainer.insertAdjacentHTML('beforeend', feeHtml);
            
            // æ·»åŠ åˆ°è‡ªå®šä¹‰è´¹ç”¨æ•°ç»„
            customFees.push({
                id: feeId,
                name: `å…¶ä»–è´¹ç”¨${feeId}`,
                value: 0
            });
            
            // æ˜¾ç¤ºå¯¹åº”çš„è¡¨å¤´
            document.getElementById(`otherFee${feeId}Header`).style.display = 'table-cell';
            document.getElementById(`totalOtherFee${feeId}`).style.display = 'table-cell';
            
            currentCustomFeeId++;
        }

        // ç§»é™¤è‡ªå®šä¹‰è´¹ç”¨
        function removeCustomFee(feeId) {
            const feeElement = document.getElementById(`customFee${feeId}`);
            if (feeElement) {
                feeElement.remove();
                
                // ä»è‡ªå®šä¹‰è´¹ç”¨æ•°ç»„ä¸­ç§»é™¤
                customFees = customFees.filter(fee => fee.id !== feeId);
                
                // éšè—å¯¹åº”çš„è¡¨å¤´
                document.getElementById(`otherFee${feeId}Header`).style.display = 'none';
                document.getElementById(`totalOtherFee${feeId}`).style.display = 'none';
            }
        }

        // åº”ç”¨è´¹ç”¨åˆ°æ‰€æœ‰é€‰ä¸­é¡¹ - å¢å¼ºç‰ˆæœ¬
        function applyAllFees() {
            if (selectedItemsForBill.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©æŠ¥å…³æ•°æ®');
                return;
            }
            
            // è·å–è´¹ç”¨è®¾ç½®
            const customsFee = parseFloat(document.getElementById('customsFee').value) || 0;
            const inspectionFee = parseFloat(document.getElementById('inspectionFee').value) || 0;
            const documentFee = parseFloat(document.getElementById('documentFee').value) || 0;
            const otherFee1 = parseFloat(document.getElementById('otherFee1').value) || 0;
            const otherFee2 = parseFloat(document.getElementById('otherFee2').value) || 0;
            
            // è·å–è‡ªå®šä¹‰è´¹ç”¨
            const customFeeValues = {};
            customFees.forEach(fee => {
                const feeValue = parseFloat(document.getElementById(`otherFee${fee.id}`).value) || 0;
                customFeeValues[fee.id] = feeValue;
            });
            
            // åº”ç”¨åˆ°æ‰€æœ‰é€‰ä¸­é¡¹
            selectedItemsForBill.forEach(item => {
                // è®¾ç½®åŸºç¡€è´¹ç”¨
                item.customsFee = customsFee;
                item.inspectionFee = inspectionFee;
                item.documentFee = documentFee;
                item.otherFee1 = otherFee1;
                item.otherFee2 = otherFee2;
                
                // è®¾ç½®è‡ªå®šä¹‰è´¹ç”¨
                customFees.forEach(fee => {
                    item[`otherFee${fee.id}`] = customFeeValues[fee.id] || 0;
                });
            });
            
            // è§¦å‘é¢„è§ˆæ›´æ–°
            previewBill();
            
            alert(`å·²æˆåŠŸå°†è´¹ç”¨è®¾ç½®åº”ç”¨åˆ° ${selectedItemsForBill.length} ä¸ªé€‰ä¸­é¡¹`);
        }

        // æœç´¢è´¦å•é¢„è§ˆæ•°æ®
        function searchBillPreview() {
            const query = document.getElementById('billPreviewSearch').value.trim();
            const searchType = document.getElementById('billPreviewSearchType').value;
            
            searchBillQuery = query;
            searchBillType = searchType;
            
            if (!query) {
                // æ¸…ç©ºæœç´¢ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®
                renderBillPreviewTable();
                return;
            }
            
            // ç­›é€‰æ•°æ®
            const filteredItems = selectedItemsForBill.filter(item => {
                const searchField = item[searchType] || '';
                return searchField.toString().toLowerCase().includes(query.toLowerCase());
            });
            
            if (filteredItems.length === 0) {
                alert('æœªæ‰¾åˆ°åŒ¹é…çš„æ•°æ®');
                return;
            }
            
            // é«˜äº®æ˜¾ç¤ºåŒ¹é…çš„æ•°æ®
            highlightSearchResults(filteredItems);
        }

        // é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
        function highlightSearchResults(filteredItems) {
            const tbody = document.getElementById('billPreviewBody');
            const rows = tbody.querySelectorAll('tr');
            
            // å…ˆç§»é™¤æ‰€æœ‰é«˜äº®
            rows.forEach(row => {
                row.classList.remove('table-warning');
            });
            
            // é«˜äº®åŒ¹é…çš„è¡Œ
            filteredItems.forEach(item => {
                const row = tbody.querySelector(`tr[data-id="${item.id}"]`);
                if (row) {
                    row.classList.add('table-warning');
                    
                    // æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
            
            alert(`æ‰¾åˆ° ${filteredItems.length} æ¡åŒ¹é…æ•°æ®`);
        }

        // é¢„è§ˆè´¦å•
        function previewBill() {
            if (selectedItemsForBill.length === 0) {
                alert('è¯·é€‰æ‹©è¦ç”Ÿæˆè´¦å•çš„æŠ¥å…³æ•°æ®');
                return;
            }
            
            // ç¡®ä¿æ‰€æœ‰é€‰ä¸­é¡¹éƒ½æœ‰å¤‡æ³¨å­—æ®µ
            selectedItemsForBill.forEach(item => {
                if (!item.hasOwnProperty('remark')) {
                    item.remark = ''; // è®¾ç½®é»˜è®¤ç©ºå¤‡æ³¨
                }
            });
            
            renderBillPreviewTable();
        }

        // æ¸²æŸ“è´¦å•é¢„è§ˆè¡¨æ ¼ - å¢å¼ºç‰ˆæœ¬
        function renderBillPreviewTable() {
            if (selectedItemsForBill.length === 0) {
                document.getElementById('billPreviewBody').innerHTML = '<tr><td colspan="15" class="text-center">è¯·å…ˆé€‰æ‹©æŠ¥å…³æ•°æ®</td></tr>';
                return;
            }
            
            // è·å–è´¹ç”¨è®¾ç½®
            const customsFee = parseFloat(document.getElementById('customsFee').value) || 0;
            const inspectionFee = parseFloat(document.getElementById('inspectionFee').value) || 0;
            const documentFee = parseFloat(document.getElementById('documentFee').value) || 0;
            const otherFee1 = parseFloat(document.getElementById('otherFee1').value) || 0;
            const otherFee2 = parseFloat(document.getElementById('otherFee2').value) || 0;
            
            // è·å–å…¶ä»–è´¹ç”¨åç§°
            const otherFee1Name = document.getElementById('otherFee1Name').value || 'å…¶ä»–è´¹ç”¨1';
            const otherFee2Name = document.getElementById('otherFee2Name').value || 'å…¶ä»–è´¹ç”¨2';
            
            // è·å–è‡ªå®šä¹‰è´¹ç”¨
            const customFeeValues = {};
            customFees.forEach(fee => {
                const feeValue = parseFloat(document.getElementById(`otherFee${fee.id}`).value) || 0;
                const feeName = document.getElementById(`otherFee${fee.id}Name`).value || `å…¶ä»–è´¹ç”¨${fee.id}`;
                customFeeValues[fee.id] = {
                    name: feeName,
                    value: feeValue
                };
            });
            
            // æ›´æ–°è¡¨å¤´
            document.getElementById('otherFee1Header').textContent = otherFee1Name;
            document.getElementById('otherFee2Header').textContent = otherFee2Name;
            
            customFees.forEach(fee => {
                document.getElementById(`otherFee${fee.id}Header`).textContent = customFeeValues[fee.id].name;
            });
            
            // æ¸²æŸ“è´¦å•é¢„è§ˆ
            const tbody = document.getElementById('billPreviewBody');
            tbody.innerHTML = '';
            
            let totalCustomsFee = 0;
            let totalInspectionFee = 0;
            let totalDocumentFee = 0;
            let totalOtherFee1 = 0;
            let totalOtherFee2 = 0;
            let totalOtherFee3 = 0;
            let totalOtherFee4 = 0;
            let grandTotal = 0;
            
            selectedItemsForBill.forEach((item, index) => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', item.id);
                
                // ä½¿ç”¨é¢„è®¾è´¹ç”¨æˆ–é»˜è®¤è´¹ç”¨
                const itemCustomsFee = item.customsFee !== undefined ? item.customsFee : customsFee;
                const itemInspectionFee = item.inspectionFee !== undefined ? item.inspectionFee : inspectionFee;
                const itemDocumentFee = item.documentFee !== undefined ? item.documentFee : documentFee;
                const itemOtherFee1 = item.otherFee1 !== undefined ? item.otherFee1 : otherFee1;
                const itemOtherFee2 = item.otherFee2 !== undefined ? item.otherFee2 : otherFee2;
                
                // è®¡ç®—è‡ªå®šä¹‰è´¹ç”¨
                const itemCustomFees = {};
                let itemCustomFeesTotal = 0;
                customFees.forEach(fee => {
                    itemCustomFees[fee.id] = item[`otherFee${fee.id}`] !== undefined ? item[`otherFee${fee.id}`] : customFeeValues[fee.id].value;
                    itemCustomFeesTotal += itemCustomFees[fee.id];
                });
                
                const itemTotal = itemCustomsFee + itemInspectionFee + itemDocumentFee + itemOtherFee1 + itemOtherFee2 + itemCustomFeesTotal;
                
                // ç´¯åŠ æ€»è®¡
                totalCustomsFee += itemCustomsFee;
                totalInspectionFee += itemInspectionFee;
                totalDocumentFee += itemDocumentFee;
                totalOtherFee1 += itemOtherFee1;
                totalOtherFee2 += itemOtherFee2;
                
                customFees.forEach(fee => {
                    if (fee.id === 3) totalOtherFee3 += itemCustomFees[fee.id] || 0;
                    if (fee.id === 4) totalOtherFee4 += itemCustomFees[fee.id] || 0;
                });
                
                grandTotal += itemTotal;
                
                let customFeesHtml = '';
                customFees.forEach(fee => {
                    customFeesHtml += `
                        <td>
                            <input type="number" class="form-control form-control-sm fee-edit-input" 
                                   data-id="${item.id}" data-fee="otherFee${fee.id}" 
                                   value="${(itemCustomFees[fee.id] || 0).toFixed(2)}" step="0.01" min="0">
                        </td>`;
                });
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.arrivalDate}</td>
                    <td>${item.billNo}</td>
                    <td>${item.containerNo}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm fee-edit-input" 
                               data-id="${item.id}" data-fee="customsFee" 
                               value="${itemCustomsFee.toFixed(2)}" step="0.01" min="0">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm fee-edit-input" 
                               data-id="${item.id}" data-fee="inspectionFee" 
                               value="${itemInspectionFee.toFixed(2)}" step="0.01" min="0">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm fee-edit-input" 
                               data-id="${item.id}" data-fee="documentFee" 
                               value="${itemDocumentFee.toFixed(2)}" step="0.01" min="0">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm fee-edit-input" 
                               data-id="${item.id}" data-fee="otherFee1" 
                               value="${itemOtherFee1.toFixed(2)}" step="0.01" min="0">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm fee-edit-input" 
                               data-id="${item.id}" data-fee="otherFee2" 
                               value="${itemOtherFee2.toFixed(2)}" step="0.01" min="0">
                    </td>
                    ${customFeesHtml}
                    <td class="fw-bold">${itemTotal.toFixed(2)}</td>
                    <td>
                        <input type="text" class="form-control form-control-sm remark-input" 
                               placeholder="å¤‡æ³¨" data-id="${item.id}" value="${item.remark || ''}">
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // æ›´æ–°æ€»è®¡è¡Œ
            document.getElementById('totalCustomsFee').textContent = totalCustomsFee.toFixed(2);
            document.getElementById('totalInspectionFee').textContent = totalInspectionFee.toFixed(2);
            document.getElementById('totalDocumentFee').textContent = totalDocumentFee.toFixed(2);
            document.getElementById('totalOtherFee1').textContent = totalOtherFee1.toFixed(2);
            document.getElementById('totalOtherFee2').textContent = totalOtherFee2.toFixed(2);
            
            if (customFees.some(fee => fee.id === 3)) {
                document.getElementById('totalOtherFee3').textContent = totalOtherFee3.toFixed(2);
            }
            if (customFees.some(fee => fee.id === 4)) {
                document.getElementById('totalOtherFee4').textContent = totalOtherFee4.toFixed(2);
            }
            
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
            
            // ç»‘å®šè´¹ç”¨ç¼–è¾‘äº‹ä»¶
            bindFeeEditEvents();
            
            // å¯ç”¨PDFå¯¼å‡ºæŒ‰é’®
            document.getElementById('exportBillPdf').disabled = false;
            
            // å¦‚æœæœ‰æœç´¢æ¡ä»¶ï¼Œé«˜äº®æ˜¾ç¤ºç»“æœ
            if (searchBillQuery) {
                const filteredItems = selectedItemsForBill.filter(item => {
                    const searchField = item[searchBillType] || '';
                    return searchField.toString().toLowerCase().includes(searchBillQuery.toLowerCase());
                });
                highlightSearchResults(filteredItems);
            }
        }

        // ç»‘å®šè´¹ç”¨ç¼–è¾‘äº‹ä»¶
        function bindFeeEditEvents() {
            document.querySelectorAll('.fee-edit-input').forEach(input => {
                input.addEventListener('change', function() {
                    const itemId = this.getAttribute('data-id');
                    const feeType = this.getAttribute('data-fee');
                    const value = parseFloat(this.value) || 0;
                    
                    // æ›´æ–°å¯¹åº”æ•°æ®é¡¹çš„è´¹ç”¨
                    const item = selectedItemsForBill.find(item => item.id === itemId);
                    if (item) {
                        item[feeType] = value;
                        
                        // é‡æ–°è®¡ç®—å¹¶æ›´æ–°è¯¥è¡Œçš„æ€»è®¡
                        updateRowTotal(itemId);
                    }
                });
            });
            
            // ç»‘å®šå¤‡æ³¨è¾“å…¥äº‹ä»¶
            bindRemarkEditEvents();
        }
        
        // ç»‘å®šå¤‡æ³¨ç¼–è¾‘äº‹ä»¶
        function bindRemarkEditEvents() {
            document.querySelectorAll('.remark-input').forEach(input => {
                input.addEventListener('change', function() {
                    const itemId = this.getAttribute('data-id');
                    const value = this.value;
                    
                    const item = selectedItemsForBill.find(item => item.id === itemId);
                    if (item) {
                        item.remark = value;
                    }
                });
            });
        }

        // æ›´æ–°å•è¡Œæ€»è®¡
        function updateRowTotal(itemId) {
            const item = selectedItemsForBill.find(item => item.id === itemId);
            if (!item) return;
            
            // è®¡ç®—è¯¥è¡Œæ€»è®¡
            let rowTotal = 0;
            
            // åŸºç¡€è´¹ç”¨
            rowTotal += item.customsFee || 0;
            rowTotal += item.inspectionFee || 0;
            rowTotal += item.documentFee || 0;
            rowTotal += item.otherFee1 || 0;
            rowTotal += item.otherFee2 || 0;
            
            // è‡ªå®šä¹‰è´¹ç”¨
            customFees.forEach(fee => {
                rowTotal += item[`otherFee${fee.id}`] || 0;
            });
            
            // æ›´æ–°æ˜¾ç¤ºçš„æ€»è®¡
            const row = document.querySelector(`tr[data-id="${itemId}"]`);
            if (row) {
                const totalCell = row.querySelector('td.fw-bold');
                if (totalCell) {
                    totalCell.textContent = rowTotal.toFixed(2);
                }
            }
            
            // æ›´æ–°å…¨å±€æ€»è®¡
            updateGrandTotal();
        }

        // æ›´æ–°å…¨å±€æ€»è®¡
        function updateGrandTotal() {
            let totalCustomsFee = 0;
            let totalInspectionFee = 0;
            let totalDocumentFee = 0;
            let totalOtherFee1 = 0;
            let totalOtherFee2 = 0;
            let totalOtherFee3 = 0;
            let totalOtherFee4 = 0;
            let grandTotal = 0;
            
            selectedItemsForBill.forEach(item => {
                totalCustomsFee += item.customsFee || 0;
                totalInspectionFee += item.inspectionFee || 0;
                totalDocumentFee += item.documentFee || 0;
                totalOtherFee1 += item.otherFee1 || 0;
                totalOtherFee2 += item.otherFee2 || 0;
                
                customFees.forEach(fee => {
                    if (fee.id === 3) totalOtherFee3 += item[`otherFee${fee.id}`] || 0;
                    if (fee.id === 4) totalOtherFee4 += item[`otherFee${fee.id}`] || 0;
                });
                
                grandTotal += (item.customsFee || 0) + (item.inspectionFee || 0) + (item.documentFee || 0) + 
                             (item.otherFee1 || 0) + (item.otherFee2 || 0);
                
                customFees.forEach(fee => {
                    grandTotal += item[`otherFee${fee.id}`] || 0;
                });
            });
            
            // æ›´æ–°æ€»è®¡æ˜¾ç¤º
            document.getElementById('totalCustomsFee').textContent = totalCustomsFee.toFixed(2);
            document.getElementById('totalInspectionFee').textContent = totalInspectionFee.toFixed(2);
            document.getElementById('totalDocumentFee').textContent = totalDocumentFee.toFixed(2);
            document.getElementById('totalOtherFee1').textContent = totalOtherFee1.toFixed(2);
            document.getElementById('totalOtherFee2').textContent = totalOtherFee2.toFixed(2);
            
            if (customFees.some(fee => fee.id === 3)) {
                document.getElementById('totalOtherFee3').textContent = totalOtherFee3.toFixed(2);
            }
            if (customFees.some(fee => fee.id === 4)) {
                document.getElementById('totalOtherFee4').textContent = totalOtherFee4.toFixed(2);
            }
            
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
        }

        // å¯¼å‡ºè´¦å•Excel - ä¸¥æ ¼æŒ‰ç…§æ¨¡æ¿æ ¼å¼
        function exportBillExcel() {
            if (!checkLogin()) return;
            
            if (selectedItemsForBill.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©æŠ¥å…³æ•°æ®å¹¶ç”Ÿæˆé¢„è§ˆ');
                return;
            }

            try {
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                
                // è·å–è´¹ç”¨è®¾ç½®
                const customsFee = parseFloat(document.getElementById('customsFee').value) || 0;
                const inspectionFee = parseFloat(document.getElementById('inspectionFee').value) || 0;
                const documentFee = parseFloat(document.getElementById('documentFee').value) || 0;
                const otherFee1 = parseFloat(document.getElementById('otherFee1').value) || 0;
                const otherFee2 = parseFloat(document.getElementById('otherFee2').value) || 0;
                
                // è·å–å…¶ä»–è´¹ç”¨åç§°
                const otherFee1Name = document.getElementById('otherFee1Name').value || 'å…¶ä»–è´¹ç”¨1';
                const otherFee2Name = document.getElementById('otherFee2Name').value || 'å…¶ä»–è´¹ç”¨2';
                
                // è·å–è‡ªå®šä¹‰è´¹ç”¨
                const customFeeValues = {};
                customFees.forEach(fee => {
                    const feeValue = parseFloat(document.getElementById(`otherFee${fee.id}`).value) || 0;
                    const feeName = document.getElementById(`otherFee${fee.id}Name`).value || `å…¶ä»–è´¹ç”¨${fee.id}`;
                    customFeeValues[fee.id] = {
                        name: feeName,
                        value: feeValue
                    };
                });

                // å‡†å¤‡æ•°æ®
                const companyName = document.getElementById('companyName').value;
                const year = document.getElementById('billYear').value;
                const month = document.getElementById('billMonth').value;
                
                // åˆ›å»ºæ ‡é¢˜è¡Œ - ç¬¬ä¸€è¡Œï¼šåˆå¹¶å•å…ƒæ ¼
                const titleRow = [`${companyName}    ${year}å¹´${month}æœˆæŠ¥å…³è´¹`];
                
                // åˆ›å»ºè¡¨å¤´ - ç¬¬äºŒè¡Œ
                const headers = ['åºå·', 'åˆ°æ¸¯æ—¶é—´', 'æå•å·', 'æŸœå·', 'æŠ¥å…³è´¹', 'æŸ¥éªŒæœåŠ¡è´¹', 'ä»£ç†æ¢å•è´¹', otherFee1Name, otherFee2Name];
                
                // æ·»åŠ è‡ªå®šä¹‰è´¹ç”¨è¡¨å¤´
                customFees.forEach(fee => {
                    headers.push(customFeeValues[fee.id].name);
                });
                
                headers.push('åˆè®¡', 'å¤‡æ³¨');
                
                // åˆ›å»ºæ•°æ®è¡Œ
                const dataRows = [];
                let totalCustomsFee = 0;
                let totalInspectionFee = 0;
                let totalDocumentFee = 0;
                let totalOtherFee1 = 0;
                let totalOtherFee2 = 0;
                let totalOtherFee3 = 0;
                let totalOtherFee4 = 0;
                let grandTotal = 0;
                
                selectedItemsForBill.forEach((item, index) => {
                    // ä½¿ç”¨å®é™…è®¾ç½®çš„è´¹ç”¨ï¼Œè€Œä¸æ˜¯é»˜è®¤è´¹ç”¨
                    const itemCustomsFee = item.customsFee !== undefined ? item.customsFee : customsFee;
                    const itemInspectionFee = item.inspectionFee !== undefined ? item.inspectionFee : inspectionFee;
                    const itemDocumentFee = item.documentFee !== undefined ? item.documentFee : documentFee;
                    const itemOtherFee1 = item.otherFee1 !== undefined ? item.otherFee1 : otherFee1;
                    const itemOtherFee2 = item.otherFee2 !== undefined ? item.otherFee2 : otherFee2;
                    
                    // è®¡ç®—è‡ªå®šä¹‰è´¹ç”¨
                    const itemCustomFees = {};
                    let itemCustomFeesTotal = 0;
                    customFees.forEach(fee => {
                        itemCustomFees[fee.id] = item[`otherFee${fee.id}`] !== undefined ? item[`otherFee${fee.id}`] : customFeeValues[fee.id].value;
                        itemCustomFeesTotal += itemCustomFees[fee.id];
                    });
                    
                    const itemTotal = itemCustomsFee + itemInspectionFee + itemDocumentFee + itemOtherFee1 + itemOtherFee2 + itemCustomFeesTotal;
                    
                    // ç´¯åŠ æ€»è®¡
                    totalCustomsFee += itemCustomsFee;
                    totalInspectionFee += itemInspectionFee;
                    totalDocumentFee += itemDocumentFee;
                    totalOtherFee1 += itemOtherFee1;
                    totalOtherFee2 += itemOtherFee2;
                    
                    customFees.forEach(fee => {
                        if (fee.id === 3) totalOtherFee3 += itemCustomFees[fee.id] || 0;
                        if (fee.id === 4) totalOtherFee4 += itemCustomFees[fee.id] || 0;
                    });
                    
                    grandTotal += itemTotal;
                    
                    const row = [
                        index + 1,
                        item.arrivalDate,
                        item.billNo,
                        item.containerNo,
                        itemCustomsFee,
                        itemInspectionFee,
                        itemDocumentFee,
                        itemOtherFee1,
                        itemOtherFee2
                    ];
                    
                    // æ·»åŠ è‡ªå®šä¹‰è´¹ç”¨åˆ—
                    customFees.forEach(fee => {
                        row.push(itemCustomFees[fee.id] || 0);
                    });
                    
                    row.push(itemTotal, item.remark || '');
                    
                    dataRows.push(row);
                });
                
                // åˆ›å»ºæ€»è®¡è¡Œ
                const totalRow = ['åˆè®¡', '', '', '', totalCustomsFee, totalInspectionFee, totalDocumentFee, totalOtherFee1, totalOtherFee2];
                
                // æ·»åŠ è‡ªå®šä¹‰è´¹ç”¨æ€»è®¡
                customFees.forEach(fee => {
                    if (fee.id === 3) totalRow.push(totalOtherFee3);
                    if (fee.id === 4) totalRow.push(totalOtherFee4);
                });
                
                totalRow.push(grandTotal, '');
                
                // åˆ›å»ºå¤‡æ³¨è¡Œ
                const remarkRow = ['å¤‡æ³¨ï¼šå¦‚å†·åº“æ ¹æ®æœ¬æ¨¡æ¿æä¾›æ¯æœˆè´¹ç”¨æ˜ç»†æ¸…å•ï¼Œåˆ™ä¼˜åˆç»™äºˆå†·åº“ä¼˜å…ˆå¯¹è´¦æ”¿ç­–ã€‚'];
                
                // åˆå¹¶æ‰€æœ‰æ•°æ®
                const wsData = [
                    titleRow,
                    headers,
                    ...dataRows,
                    totalRow,
                    remarkRow
                ];
                
                // åˆ›å»ºå·¥ä½œè¡¨
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // è®¾ç½®åˆå¹¶å•å…ƒæ ¼ï¼ˆæ ‡é¢˜è¡Œï¼‰
                if (!ws['!merges']) ws['!merges'] = [];
                // åˆå¹¶ç¬¬ä¸€è¡Œçš„æ‰€æœ‰åˆ—
                ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } });
                
                // è®¾ç½®åˆ—å®½
                const colWidths = [
                    { wch: 8 },  // åºå·
                    { wch: 12 }, // åˆ°æ¸¯æ—¶é—´
                    { wch: 15 }, // æå•å·
                    { wch: 15 }, // æŸœå·
                    { wch: 10 }, // æŠ¥å…³è´¹
                    { wch: 12 }, // æŸ¥éªŒæœåŠ¡è´¹
                    { wch: 12 }, // ä»£ç†æ¢å•è´¹
                    { wch: 15 }, // å…¶ä»–è´¹ç”¨1
                    { wch: 15 }, // å…¶ä»–è´¹ç”¨2
                ];
                
                // æ·»åŠ è‡ªå®šä¹‰è´¹ç”¨åˆ—å®½
                customFees.forEach(() => {
                    colWidths.push({ wch: 15 });
                });
                
                // æ·»åŠ åˆè®¡å’Œå¤‡æ³¨åˆ—å®½
                colWidths.push({ wch: 10 }, { wch: 20 });
                
                ws['!cols'] = colWidths;
                
                // è®¾ç½®å•å…ƒæ ¼æ ·å¼
                const range = XLSX.utils.decode_range(ws['!ref']);
                
                // éå†æ‰€æœ‰å•å…ƒæ ¼è®¾ç½®æ ·å¼
                for (let R = range.s.r; R <= range.e.r; R++) {
                    for (let C = range.s.c; C <= range.e.c; C++) {
                        const cell_address = {c: C, r: R};
                        const cell_ref = XLSX.utils.encode_cell(cell_address);
                        
                        if (!ws[cell_ref]) continue;
                        
                        // è®¾ç½®è¾¹æ¡†
                        if (!ws[cell_ref].s) ws[cell_ref].s = {};
                        ws[cell_ref].s.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                        
                        // è®¾ç½®å¯¹é½æ–¹å¼
                        ws[cell_ref].s.alignment = {
                            horizontal: 'center',
                            vertical: 'center'
                        };
                        
                        // ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜è¡Œæ ·å¼
                        if (R === 0) {
                            ws[cell_ref].s.font = {
                                name: 'å®‹ä½“',
                                sz: 18,
                                bold: true
                            };
                        }
                        // ç¬¬äºŒè¡Œï¼šè¡¨å¤´è¡Œæ ·å¼
                        else if (R === 1) {
                            ws[cell_ref].s.font = {
                                name: 'å®‹ä½“',
                                sz: 12
                            };
                        }
                        // æ•°æ®è¡Œæ ·å¼
                        else if (R < wsData.length - 2) {
                            ws[cell_ref].s.font = {
                                name: 'å®‹ä½“',
                                sz: 11
                            };
                        }
                        // åˆè®¡è¡Œæ ·å¼
                        else if (R === wsData.length - 2) {
                            ws[cell_ref].s.font = {
                                name: 'å®‹ä½“',
                                sz: 11,
                                bold: true
                            };
                        }
                        // å¤‡æ³¨è¡Œæ ·å¼
                        else if (R === wsData.length - 1) {
                            ws[cell_ref].s.font = {
                                name: 'å®‹ä½“',
                                sz: 11,
                                bold: true
                            };
                            ws[cell_ref].s.alignment = {
                                horizontal: 'left',
                                vertical: 'center'
                            };
                        }
                    }
                }
                
                // æ·»åŠ åˆ°å·¥ä½œç°¿
                XLSX.utils.book_append_sheet(wb, ws, 'è´¦å•');
                
                // ç”Ÿæˆæ–‡ä»¶å
                const fileName = `${companyName}${year}å¹´${month}æœˆæŠ¥å…³è´¹.xlsx`;
                
                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(wb, fileName);
                
            } catch (error) {
                console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
                alert('å¯¼å‡ºExcelå¤±è´¥: ' + error.message);
            }
        }

        // ä¿å­˜ç”Ÿæˆçš„è´¦å•
        async function saveGeneratedBill() {
            if (!checkLogin()) return;
            
            if (selectedItemsForBill.length === 0) {
                alert('è¯·é€‰æ‹©è¦ç”Ÿæˆè´¦å•çš„æŠ¥å…³æ•°æ®');
                return;
            }
            
            const companyName = document.getElementById('companyName').value;
            const year = document.getElementById('billYear').value;
            const month = document.getElementById('billMonth').value;
            
            if (!companyName) {
                alert('è¯·å¡«å†™å…¬å¸åç§°');
                return;
            }
            
            try {
                // è·å–è´¹ç”¨è®¾ç½®
                const customsFee = parseFloat(document.getElementById('customsFee').value) || 0;
                const inspectionFee = parseFloat(document.getElementById('inspectionFee').value) || 0;
                const documentFee = parseFloat(document.getElementById('documentFee').value) || 0;
                const otherFee1 = parseFloat(document.getElementById('otherFee1').value) || 0;
                const otherFee2 = parseFloat(document.getElementById('otherFee2').value) || 0;
                
                // è·å–å…¶ä»–è´¹ç”¨åç§°
                const otherFee1Name = document.getElementById('otherFee1Name').value || 'å…¶ä»–è´¹ç”¨1';
                const otherFee2Name = document.getElementById('otherFee2Name').value || 'å…¶ä»–è´¹ç”¨2';
                
                // è·å–è‡ªå®šä¹‰è´¹ç”¨
                const customFeeValues = [];
                customFees.forEach(fee => {
                    const feeValue = parseFloat(document.getElementById(`otherFee${fee.id}`).value) || 0;
                    const feeName = document.getElementById(`otherFee${fee.id}Name`).value || `å…¶ä»–è´¹ç”¨${fee.id}`;
                    customFeeValues.push({
                        id: fee.id,
                        name: feeName,
                        value: feeValue
                    });
                });
                
                // è·å–å¤‡æ³¨
                const billItems = selectedItemsForBill.map((item, index) => {
                    const remarkInput = document.querySelector(`input[data-id="${item.id}"]`);
                    const remark = remarkInput ? remarkInput.value : '';
                    
                    // ä½¿ç”¨å®é™…è®¾ç½®çš„è´¹ç”¨ï¼Œè€Œä¸æ˜¯é»˜è®¤è´¹ç”¨
                    const itemCustomsFee = item.customsFee !== undefined ? item.customsFee : customsFee;
                    const itemInspectionFee = item.inspectionFee !== undefined ? item.inspectionFee : inspectionFee;
                    const itemDocumentFee = item.documentFee !== undefined ? item.documentFee : documentFee;
                    const itemOtherFee1 = item.otherFee1 !== undefined ? item.otherFee1 : otherFee1;
                    const itemOtherFee2 = item.otherFee2 !== undefined ? item.otherFee2 : otherFee2;
                    
                    // è®¡ç®—è‡ªå®šä¹‰è´¹ç”¨
                    let itemCustomFeesTotal = 0;
                    const itemCustomFees = {};
                    customFees.forEach(fee => {
                        itemCustomFees[`otherFee${fee.id}`] = item[`otherFee${fee.id}`] !== undefined ? item[`otherFee${fee.id}`] : customFeeValues.find(f => f.id === fee.id)?.value || 0;
                        itemCustomFeesTotal += itemCustomFees[`otherFee${fee.id}`];
                    });
                    
                    const itemTotal = itemCustomsFee + itemInspectionFee + itemDocumentFee + itemOtherFee1 + itemOtherFee2 + itemCustomFeesTotal;
                    
                    return {
                        id: index + 1,
                        customsDataId: item.id,
                        arrivalDate: item.arrivalDate,
                        declareDate: item.declareDate,
                        billNo: item.billNo,
                        containerNo: item.containerNo,
                        customsNo: item.customsNo,
                        domesticConsignee: item.domesticConsignee,
                        consumptionUnit: item.consumptionUnit,
                        country: item.country,
                        productName: item.productName,
                        customsFee: itemCustomsFee,
                        inspectionFee: itemInspectionFee,
                        documentFee: itemDocumentFee,
                        otherFee1: itemOtherFee1,
                        otherFee2: itemOtherFee2,
                        otherFee1Name: otherFee1Name,
                        otherFee2Name: otherFee2Name,
                        ...itemCustomFees,
                        total: itemTotal,
                        remark: remark
                    };
                });
                
                // è®¡ç®—æ€»é‡‘é¢
                const totalAmount = billItems.reduce((sum, item) => sum + item.total, 0);
                
                // åˆ›å»ºè‡ªå®šä¹‰è´¹ç”¨é…ç½®
                const customFeesConfig = [
                    { name: 'æŠ¥å…³è´¹', value: customsFee },
                    { name: 'æŸ¥éªŒæœåŠ¡è´¹', value: inspectionFee },
                    { name: 'ä»£ç†æ¢å•è´¹', value: documentFee },
                    { name: otherFee1Name, value: otherFee1 },
                    { name: otherFee2Name, value: otherFee2 },
                    ...customFeeValues
                ];
                
                // åˆ›å»ºè´¦å•å¯¹è±¡
                const newBill = {
                    billNo: generateBillNo(),
                    billDate: new Date().toISOString().split('T')[0],
                    companyName: companyName,
                    year: year,
                    month: month,
                    billItems: billItems,
                    totalAmount: totalAmount,
                    currency: 'CNY',
                    billStatus: 'æœªç¡®è®¤',
                    customFees: customFeesConfig
                };
                
                // ä¿å­˜åˆ°LeanCloud
                const success = await saveBillToLeanCloud(newBill, true);
                
                if (success) {
                    alert('è´¦å•ä¿å­˜æˆåŠŸ');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('generateBillModal'));
                    modal.hide();
                    await loadListData();
                } else {
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                
            } catch (error) {
                console.error('ä¿å­˜è´¦å•å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºè´¦å•è¯¦æƒ…
        function showBillDetail(id) {
            if (!checkLogin()) return;
            
            const item = billsData.find(item => item.id === id);
            if (!item) {
                alert('æ‰¾ä¸åˆ°å¯¹åº”çš„è´¦å•æ•°æ®');
                return;
            }

            // è®¾ç½®å½“å‰è´¦å•ID
            document.getElementById('billDetailModal').setAttribute('data-current-id', id);

            // å¡«å……åŸºæœ¬ä¿¡æ¯
            document.getElementById('detailBillNo').textContent = item.billNo;
            document.getElementById('detailCompanyName').textContent = item.companyName;
            document.getElementById('detailBillDate').textContent = item.billDate;
            document.getElementById('detailBillStatus').textContent = item.billStatus;
            document.getElementById('detailTotalAmount').textContent = formatCurrency(item.totalAmount || 0, item.currency);
            document.getElementById('detailPaymentDate').textContent = item.paymentDate || '-';
            document.getElementById('detailPayee').textContent = item.payee || '-';
            document.getElementById('detailRemark').textContent = item.remark || '-';
            
            // æ›´æ–°å…¶ä»–è´¹ç”¨è¡¨å¤´
            const customFeesConfig = item.customFees || [];
            document.getElementById('detailOtherFee1Header').textContent = customFeesConfig[3]?.name || 'å…¶ä»–è´¹ç”¨1';
            document.getElementById('detailOtherFee2Header').textContent = customFeesConfig[4]?.name || 'å…¶ä»–è´¹ç”¨2';
            
            // æ˜¾ç¤ºè‡ªå®šä¹‰è´¹ç”¨è¡¨å¤´
            if (customFeesConfig[5]) {
                document.getElementById('detailOtherFee3Header').style.display = 'table-cell';
                document.getElementById('detailOtherFee3Header').textContent = customFeesConfig[5].name;
            } else {
                document.getElementById('detailOtherFee3Header').style.display = 'none';
            }
            
            if (customFeesConfig[6]) {
                document.getElementById('detailOtherFee4Header').style.display = 'table-cell';
                document.getElementById('detailOtherFee4Header').textContent = customFeesConfig[6].name;
            } else {
                document.getElementById('detailOtherFee4Header').style.display = 'none';
            }
            
            // å¡«å……è´¦å•æ˜ç»†
            const tbody = document.getElementById('billDetailItems');
            tbody.innerHTML = '';
            
            if (item.billItems && item.billItems.length > 0) {
                item.billItems.forEach(billItem => {
                    const row = document.createElement('tr');
                    
                    let customFeesHtml = '';
                    if (customFeesConfig[5]) {
                        customFeesHtml += `<td>${(billItem.otherFee3 || 0).toFixed(2)}</td>`;
                    }
                    if (customFeesConfig[6]) {
                        customFeesHtml += `<td>${(billItem.otherFee4 || 0).toFixed(2)}</td>`;
                    }
                    
                    row.innerHTML = `
                        <td>${billItem.id}</td>
                        <td>${billItem.arrivalDate}</td>
                        <td>${billItem.billNo}</td>
                        <td>${billItem.containerNo}</td>
                        <td>${billItem.customsNo}</td>
                        <td>${billItem.customsFee.toFixed(2)}</td>
                        <td>${billItem.inspectionFee.toFixed(2)}</td>
                        <td>${billItem.documentFee.toFixed(2)}</td>
                        <td>${billItem.otherFee1.toFixed(2)}</td>
                        <td>${billItem.otherFee2.toFixed(2)}</td>
                        ${customFeesHtml}
                        <td>${billItem.total.toFixed(2)}</td>
                        <td>${billItem.remark || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // å¡«å……å‘ç¥¨åˆ—è¡¨
            const invoiceTbody = document.getElementById('invoiceList');
            invoiceTbody.innerHTML = '';
            
            if (item.attachments && item.attachments.length > 0) {
                item.attachments.forEach((attachment, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <a href="${attachment.fileUrl}" target="_blank">${attachment.name}</a>
                        </td>
                        <td>${attachment.type || 'å‘ç¥¨'}</td>
                        <td>${attachment.uploadTime}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger delete-invoice" 
                                    data-id="${item.id}" 
                                    data-attachment-id="${attachment.id}">
                                åˆ é™¤
                            </button>
                        </td>
                    `;
                    invoiceTbody.appendChild(row);
                });
            } else {
                invoiceTbody.innerHTML = '<tr><td colspan="4" class="text-center">æš‚æ— å‘ç¥¨</td></tr>';
            }
            
            // ç»‘å®šå‘ç¥¨åˆ é™¤äº‹ä»¶
            document.querySelectorAll('.delete-invoice').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!checkLogin()) return;
                    const billId = this.getAttribute('data-id');
                    const attachmentId = this.getAttribute('data-attachment-id');
                    deleteInvoice(billId, attachmentId);
                });
            });
            
            // æ ¹æ®è´¦å•çŠ¶æ€æ§åˆ¶æŒ‰é’®
            const confirmBtn = document.getElementById('confirmBill');
            const exportPdfBtn = document.getElementById('exportDetailPdf');
            
            if (item.billStatus === 'æœªç¡®è®¤') {
                confirmBtn.style.display = 'inline-block';
                confirmBtn.disabled = false;
                exportPdfBtn.disabled = true;
            } else if (item.billStatus === 'å·²ç¡®è®¤') {
                confirmBtn.style.display = 'none';
                exportPdfBtn.disabled = false;
            } else if (item.billStatus === 'å·²æ”¶æ¬¾') {
                confirmBtn.style.display = 'none';
                exportPdfBtn.disabled = false;
            }
            
            // éšè—ä¸Šä¼ åŒºåŸŸ
            document.getElementById('invoiceUploadSection').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('billDetailModal'));
            modal.show();
        }

        // å¯¼å‡ºè¯¦æƒ…Excel - ä¸¥æ ¼æŒ‰ç…§æ¨¡æ¿æ ¼å¼
        function exportDetailExcel(billItem) {
            try {
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                
                // å‡†å¤‡æ•°æ®
                const companyName = billItem.companyName;
                const year = billItem.year;
                const month = billItem.month;
                const customFeesConfig = billItem.customFees || [];
                
                // åˆ›å»ºæ ‡é¢˜è¡Œ
                const titleRow = [`${companyName}    ${year}å¹´${month}æœˆæŠ¥å…³è´¹`];
                
                // åˆ›å»ºè¡¨å¤´
                const headers = ['åºå·', 'åˆ°æ¸¯æ—¶é—´', 'æå•å·', 'æŸœå·', 'æŠ¥å…³è´¹', 'æŸ¥éªŒæœåŠ¡è´¹', 'ä»£ç†æ¢å•è´¹'];
                
                // æ·»åŠ å…¶ä»–è´¹ç”¨è¡¨å¤´
                headers.push(
                    customFeesConfig[3]?.name || 'å…¶ä»–è´¹ç”¨1',
                    customFeesConfig[4]?.name || 'å…¶ä»–è´¹ç”¨2'
                );
                
                // æ·»åŠ è‡ªå®šä¹‰è´¹ç”¨è¡¨å¤´
                if (customFeesConfig[5]) headers.push(customFeesConfig[5].name);
                if (customFeesConfig[6]) headers.push(customFeesConfig[6].name);
                
                headers.push('åˆè®¡', 'å¤‡æ³¨');
                
                // åˆ›å»ºæ•°æ®è¡Œ
                const dataRows = [];
                let totalCustomsFee = 0;
                let totalInspectionFee = 0;
                let totalDocumentFee = 0;
                let totalOtherFee1 = 0;
                let totalOtherFee2 = 0;
                let totalOtherFee3 = 0;
                let totalOtherFee4 = 0;
                let grandTotal = 0;
                
                if (billItem.billItems && billItem.billItems.length > 0) {
                    billItem.billItems.forEach((item, index) => {
                        totalCustomsFee += item.customsFee || 0;
                        totalInspectionFee += item.inspectionFee || 0;
                        totalDocumentFee += item.documentFee || 0;
                        totalOtherFee1 += item.otherFee1 || 0;
                        totalOtherFee2 += item.otherFee2 || 0;
                        totalOtherFee3 += item.otherFee3 || 0;
                        totalOtherFee4 += item.otherFee4 || 0;
                        grandTotal += item.total || 0;
                        
                        const row = [
                            index + 1,
                            item.arrivalDate,
                            item.billNo,
                            item.containerNo,
                            item.customsFee || 0,
                            item.inspectionFee || 0,
                            item.documentFee || 0,
                            item.otherFee1 || 0,
                            item.otherFee2 || 0
                        ];
                        
                        // æ·»åŠ è‡ªå®šä¹‰è´¹ç”¨åˆ—
                        if (customFeesConfig[5]) row.push(item.otherFee3 || 0);
                        if (customFeesConfig[6]) row.push(item.otherFee4 || 0);
                        
                        row.push(item.total || 0, item.remark || '');
                        
                        dataRows.push(row);
                    });
                }
                
                // åˆ›å»ºæ€»è®¡è¡Œ
                const totalRow = ['åˆè®¡', '', '', '', totalCustomsFee, totalInspectionFee, totalDocumentFee, totalOtherFee1, totalOtherFee2];
                
                // æ·»åŠ è‡ªå®šä¹‰è´¹ç”¨æ€»è®¡
                if (customFeesConfig[5]) totalRow.push(totalOtherFee3);
                if (customFeesConfig[6]) totalRow.push(totalOtherFee4);
                
                totalRow.push(grandTotal, '');
                
                // åˆ›å»ºå¤‡æ³¨è¡Œ
                const remarkRow = ['å¤‡æ³¨ï¼šå¦‚å†·åº“æ ¹æ®æœ¬æ¨¡æ¿æä¾›æ¯æœˆè´¹ç”¨æ˜ç»†æ¸…å•ï¼Œåˆ™ä¼˜åˆç»™äºˆå†·åº“ä¼˜å…ˆå¯¹è´¦æ”¿ç­–ã€‚'];
                
                // åˆå¹¶æ‰€æœ‰æ•°æ®
                const wsData = [
                    titleRow,
                    headers,
                    ...dataRows,
                    totalRow,
                    remarkRow
                ];
                
                // åˆ›å»ºå·¥ä½œè¡¨
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // è®¾ç½®åˆå¹¶å•å…ƒæ ¼ï¼ˆæ ‡é¢˜è¡Œï¼‰
                if (!ws['!merges']) ws['!merges'] = [];
                ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } });
                
                // è®¾ç½®åˆ—å®½
                const colWidths = [
                    { wch: 8 },  // åºå·
                    { wch: 12 }, // åˆ°æ¸¯æ—¶é—´
                    { wch: 15 }, // æå•å·
                    { wch: 15 }, // æŸœå·
                    { wch: 10 }, // æŠ¥å…³è´¹
                    { wch: 12 }, // æŸ¥éªŒæœåŠ¡è´¹
                    { wch: 12 }, // ä»£ç†æ¢å•è´¹
                    { wch: 15 }, // å…¶ä»–è´¹ç”¨1
                    { wch: 15 }, // å…¶ä»–è´¹ç”¨2
                ];
                
                // æ·»åŠ è‡ªå®šä¹‰è´¹ç”¨åˆ—å®½
                if (customFeesConfig[5]) colWidths.push({ wch: 15 });
                if (customFeesConfig[6]) colWidths.push({ wch: 15 });
                
                // æ·»åŠ åˆè®¡å’Œå¤‡æ³¨åˆ—å®½
                colWidths.push({ wch: 10 }, { wch: 20 });
                
                ws['!cols'] = colWidths;
                
                // è®¾ç½®å•å…ƒæ ¼æ ·å¼ï¼ˆä¸ä¸Šé¢ç›¸åŒçš„æ ·å¼è®¾ç½®é€»è¾‘ï¼‰
                const range = XLSX.utils.decode_range(ws['!ref']);
                
                for (let R = range.s.r; R <= range.e.r; R++) {
                    for (let C = range.s.c; C <= range.e.c; C++) {
                        const cell_address = {c: C, r: R};
                        const cell_ref = XLSX.utils.encode_cell(cell_address);
                        
                        if (!ws[cell_ref]) continue;
                        
                        // è®¾ç½®è¾¹æ¡†
                        if (!ws[cell_ref].s) ws[cell_ref].s = {};
                        ws[cell_ref].s.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                        
                        // è®¾ç½®å¯¹é½æ–¹å¼
                        ws[cell_ref].s.alignment = {
                            horizontal: 'center',
                            vertical: 'center'
                        };
                        
                        // ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜è¡Œæ ·å¼
                        if (R === 0) {
                            ws[cell_ref].s.font = {
                                name: 'å®‹ä½“',
                                sz: 18,
                                bold: true
                            };
                        }
                        // ç¬¬äºŒè¡Œï¼šè¡¨å¤´è¡Œæ ·å¼
                        else if (R === 1) {
                            ws[cell_ref].s.font = {
                                name: 'å®‹ä½“',
                                sz: 12
                            };
                        }
                        // æ•°æ®è¡Œæ ·å¼
                        else if (R < wsData.length - 2) {
                            ws[cell_ref].s.font = {
                                name: 'å®‹ä½“',
                                sz: 11
                            };
                        }
                        // åˆè®¡è¡Œæ ·å¼
                        else if (R === wsData.length - 2) {
                            ws[cell_ref].s.font = {
                                name: 'å®‹ä½“',
                                sz: 11,
                                bold: true
                            };
                        }
                        // å¤‡æ³¨è¡Œæ ·å¼
                        else if (R === wsData.length - 1) {
                            ws[cell_ref].s.font = {
                                name: 'å®‹ä½“',
                                sz: 11,
                                bold: true
                            };
                            ws[cell_ref].s.alignment = {
                                horizontal: 'left',
                                vertical: 'center'
                            };
                        }
                    }
                }
                
                // æ·»åŠ åˆ°å·¥ä½œç°¿
                XLSX.utils.book_append_sheet(wb, ws, 'è´¦å•');
                
                // ç”Ÿæˆæ–‡ä»¶å
                const fileName = `${companyName}${year}å¹´${month}æœˆæŠ¥å…³è´¹.xlsx`;
                
                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(wb, fileName);
                
            } catch (error) {
                console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
                alert('å¯¼å‡ºExcelå¤±è´¥: ' + error.message);
            }
        }

        // ç¡®è®¤è´¦å•
        async function confirmBill() {
            if (!checkLogin()) return;
            
            const billId = document.getElementById('billDetailModal').getAttribute('data-current-id');
            if (!billId) {
                alert('æ— æ³•ç¡®å®šå½“å‰è´¦å•');
                return;
            }
            
            if (!confirm('ç¡®è®¤åè´¦å•å°†æ— æ³•ä¿®æ”¹ï¼Œç¡®å®šè¦ç¡®è®¤æ­¤è´¦å•å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const item = billsData.find(item => item.id === billId);
                if (!item) {
                    alert('æ‰¾ä¸åˆ°å¯¹åº”çš„è´¦å•æ•°æ®');
                    return;
                }
                
                // æ›´æ–°è´¦å•çŠ¶æ€
                item.billStatus = 'å·²ç¡®è®¤';
                
                // ä¿å­˜åˆ°LeanCloud
                if (item.leanCloudObject) {
                    item.leanCloudObject.set('billStatus', 'å·²ç¡®è®¤');
                    await item.leanCloudObject.save();
                    
                    alert('è´¦å•ç¡®è®¤æˆåŠŸ');
                    
                    // å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°æ•°æ®
                    const modal = bootstrap.Modal.getInstance(document.getElementById('billDetailModal'));
                    modal.hide();
                    await loadListData();
                }
                
            } catch (error) {
                console.error('ç¡®è®¤è´¦å•å¤±è´¥:', error);
                alert('ç¡®è®¤å¤±è´¥: ' + error.message);
            }
        }

        // ä¸Šä¼ å‘ç¥¨
        function showUploadInvoice() {
            if (!checkLogin()) return;
            document.getElementById('invoiceUploadSection').style.display = 'block';
        }

        // ç¡®è®¤ä¸Šä¼ å‘ç¥¨
        async function confirmUploadInvoice() {
            if (!checkLogin()) return;
            
            const fileInput = document.getElementById('invoiceUpload');
            const billId = document.getElementById('billDetailModal').getAttribute('data-current-id');
            
            if (!fileInput || fileInput.files.length === 0) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å‘ç¥¨æ–‡ä»¶');
                return;
            }
            
            if (!billId) {
                alert('æ— æ³•ç¡®å®šå½“å‰è´¦å•');
                return;
            }
            
            try {
                const file = fileInput.files[0];
                const avFile = new AV.File(file.name, file);
                await avFile.save();
                
                // è·å–è´¦å•å¯¹è±¡
                const item = billsData.find(item => item.id === billId);
                if (!item) {
                    alert('æ‰¾ä¸åˆ°å¯¹åº”çš„è´¦å•æ•°æ®');
                    return;
                }
                
                // æ›´æ–°é™„ä»¶åˆ—è¡¨
                const attachments = item.attachments || [];
                const newAttachment = {
                    id: attachments.length > 0 ? Math.max(...attachments.map(a => a.id || 0)) + 1 : 1,
                    type: 'å‘ç¥¨',
                    name: file.name,
                    uploadTime: new Date().toLocaleString('zh-CN'),
                    fileUrl: avFile.url(),
                    fileId: avFile.id
                };
                attachments.push(newAttachment);
                
                // ä¿å­˜åˆ°LeanCloud
                if (item.leanCloudObject) {
                    item.leanCloudObject.set('attachments', attachments);
                    await item.leanCloudObject.save();
                    
                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    item.attachments = attachments;
                    
                    alert('å‘ç¥¨ä¸Šä¼ æˆåŠŸ');
                    fileInput.value = '';
                    document.getElementById('invoiceUploadSection').style.display = 'none';
                    
                    // åˆ·æ–°å‘ç¥¨åˆ—è¡¨
                    showBillDetail(billId);
                }
                
            } catch (error) {
                console.error('ä¸Šä¼ å‘ç¥¨å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
            }
        }

        // å–æ¶ˆä¸Šä¼ 
        function cancelUpload() {
            if (!checkLogin()) return;
            document.getElementById('invoiceUpload').value = '';
            document.getElementById('invoiceUploadSection').style.display = 'none';
        }

        // åˆ é™¤å‘ç¥¨
        async function deleteInvoice(billId, attachmentId) {
            if (!checkLogin()) return;
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‘ç¥¨å—ï¼Ÿ')) return;
            
            try {
                const item = billsData.find(item => item.id === billId);
                if (!item) {
                    alert('æ‰¾ä¸åˆ°å¯¹åº”çš„è´¦å•æ•°æ®');
                    return;
                }
                
                // æ‰¾åˆ°è¦åˆ é™¤çš„é™„ä»¶
                const attachmentToDelete = item.attachments.find(att => att.id == attachmentId);
                if (!attachmentToDelete) {
                    alert('æ‰¾ä¸åˆ°è¦åˆ é™¤çš„å‘ç¥¨');
                    return;
                }
                
                const updatedAttachments = item.attachments.filter(att => att.id != attachmentId);
                
                // 1. å…ˆåˆ é™¤ LeanCloud ä¸Šçš„å®é™…æ–‡ä»¶
                if (attachmentToDelete.fileId) {
                    await deleteFileFromLeanCloud(attachmentToDelete.fileId);
                }
                
                // 2. æ›´æ–°LeanCloudè®°å½•
                if (item.leanCloudObject) {
                    item.leanCloudObject.set('attachments', updatedAttachments);
                    await item.leanCloudObject.save();
                    
                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    item.attachments = updatedAttachments;
                    
                    alert('å‘ç¥¨åˆ é™¤æˆåŠŸ');
                    
                    // åˆ·æ–°å‘ç¥¨åˆ—è¡¨
                    showBillDetail(billId);
                }
                
            } catch (error) {
                console.error('åˆ é™¤å‘ç¥¨å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // å¯¼å‡ºè´¦å•PDF
        function exportBillPdf() {
            alert('PDFå¯¼å‡ºåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
        }

        // å¯¼å‡ºè¯¦æƒ…PDF
        function exportDetailPdf() {
            exportBillPdf();
        }

        // åˆ é™¤è´¦å•
        async function deleteBill(id) {
            if (!checkLogin()) return;
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è´¦å•è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                try {
                    const itemToDelete = billsData.find(item => item.id === id);
                    
                    if (itemToDelete) {
                        const success = await deleteBillFromLeanCloud(itemToDelete);
                        
                        if (success) {
                            await loadListData();
                        } else {
                            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    }
                } catch (error) {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }

        // æ¸…ç©ºè´¦å•ç­›é€‰æ¡ä»¶
        function clearBills() {
            document.getElementById('billDateRange').value = '';
            document.getElementById('billStatusFilter').value = '';
            document.getElementById('companyNameFilter').value = '';

            applyBillsFilters();
            billsCurrentPageIndex = 1;
            updateBillsPagination();
            renderBillsTable();
            updateStatistics();
        }

        // æ›´æ–°è´¦å•åˆ†é¡µ
        function updateBillsPagination() {
            billsTotalPages = Math.ceil(filteredBillsData.length / billsItemsPerPage);
            const paginationElement = document.getElementById('billsPagination');
            
            if (billsTotalPages <= 1) {
                paginationElement.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            if (billsCurrentPageIndex > 1) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" data-page="${billsCurrentPageIndex - 1}">ä¸Šä¸€é¡µ</a></li>`;
            } else {
                paginationHTML += `<li class="page-item disabled"><a class="page-link" href="#">ä¸Šä¸€é¡µ</a></li>`;
            }
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, billsCurrentPageIndex - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(billsTotalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === billsCurrentPageIndex) {
                    paginationHTML += `<li class="page-item active"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
                } else {
                    paginationHTML += `<li class="page-item"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
                }
            }
            
            if (billsCurrentPageIndex < billsTotalPages) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" data-page="${billsCurrentPageIndex + 1}">ä¸‹ä¸€é¡µ</a></li>`;
            } else {
                paginationHTML += `<li class="page-item disabled"><a class="page-link" href="#">ä¸‹ä¸€é¡µ</a></li>`;
            }
            
            paginationElement.innerHTML = paginationHTML;
            
            document.querySelectorAll('#billsPagination .page-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    if (page && page !== billsCurrentPageIndex) {
                        billsCurrentPageIndex = page;
                        renderBillsTable();
                        updateBillsPagination();
                    }
                });
            });
        }

        // æ›´æ–°è´¦å•åˆ†é¡µä¿¡æ¯
        function updateBillsPaginationInfo() {
            const totalItems = filteredBillsData.length;
            const startItem = totalItems > 0 ? (billsCurrentPageIndex - 1) * billsItemsPerPage + 1 : 0;
            const endItem = Math.min(billsCurrentPageIndex * billsItemsPerPage, totalItems);
            
            document.getElementById('billsPaginationInfo').innerHTML = 
                `å…± ${billsTotalPages} é¡µï¼Œæ¯é¡µæ˜¾ç¤º ${billsItemsPerPage} æ¡ï¼Œå…± ${totalItems} æ¡è®°å½•ï¼Œå½“å‰æ˜¾ç¤ºç¬¬ ${startItem}-${endItem} æ¡`;
        }

        // LeanCloudè´¦å•æ•°æ®æ“ä½œ
        async function saveBillToLeanCloud(billItem, isNew = false) {
            try {
                let billObject;
                
                if (isNew) {
                    billObject = new AV.Object('Bills');
                } else {
                    billObject = billItem.leanCloudObject;
                }
                
                billObject.set('billNo', billItem.billNo);
                billObject.set('billDate', billItem.billDate);
                billObject.set('companyName', billItem.companyName);
                billObject.set('containerNo', billItem.containerNo);
                billObject.set('customsNo', billItem.customsNo);
                billObject.set('billNoSearch', billItem.billNoSearch);
                billObject.set('domesticConsignee', billItem.domesticConsignee);
                billObject.set('totalAmount', billItem.totalAmount);
                billObject.set('currency', billItem.currency);
                billObject.set('billStatus', billItem.billStatus);
                billObject.set('paymentDate', billItem.paymentDate);
                billObject.set('payee', billItem.payee);
                billObject.set('remark', billItem.remark);
                billObject.set('billItems', billItem.billItems);
                billObject.set('attachments', billItem.attachments || []);
                billObject.set('customFees', billItem.customFees || []);
                
                await billObject.save();
                
                if (isNew) {
                    billItem.leanCloudObject = billObject;
                    billItem.id = billObject.id;
                }
                
                return true;
            } catch (error) {
                console.error('ä¿å­˜åˆ°LeanCloudå¤±è´¥:', error);
                return false;
            }
        }

        async function deleteBillFromLeanCloud(billItem) {
            try {
                if (billItem.leanCloudObject) {
                    // å…ˆåˆ é™¤æ‰€æœ‰å…³è”çš„æ–‡ä»¶
                    if (billItem.attachments && billItem.attachments.length > 0) {
                        for (const attachment of billItem.attachments) {
                            if (attachment.fileId) {
                                await deleteFileFromLeanCloud(attachment.fileId);
                            }
                        }
                    }
                    
                    // å†åˆ é™¤è´¦å•è®°å½•
                    await billItem.leanCloudObject.destroy();
                    return true;
                }
                return false;
            } catch (error) {
                console.error('ä»LeanCloudåˆ é™¤å¤±è´¥:', error);
                return false;
            }
        }

        // æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
        async function checkTableExists(className) {
            try {
                const query = new AV.Query(className);
                query.limit(1);
                await query.first();
                return true;
            } catch (error) {
                if (error.code === 101) {
                    return false;
                }
                throw error;
            }
        }

        // åˆ é™¤ LeanCloud ä¸Šçš„æ–‡ä»¶
        async function deleteFileFromLeanCloud(fileId) {
            try {
                if (!fileId) {
                    console.log('æ–‡ä»¶IDä¸ºç©ºï¼Œè·³è¿‡åˆ é™¤');
                    return true;
                }
                
                const file = AV.Object.createWithoutData('_File', fileId);
                await file.destroy();
                console.log('LeanCloud æ–‡ä»¶åˆ é™¤æˆåŠŸ:', fileId);
                return true;
            } catch (error) {
                console.error('åˆ é™¤ LeanCloud æ–‡ä»¶å¤±è´¥:', error);
                // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨æˆ–å…¶ä»–é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
                return false;
            }
        }

        // å¯¼å‡ºå…¨å±€å‡½æ•°
        window.addCustomFee = addCustomFee;
        window.removeCustomFee = removeCustomFee;
        window.searchBillPreview = searchBillPreview;
    </script>
</body>
</html>